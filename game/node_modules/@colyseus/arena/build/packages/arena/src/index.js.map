{"version":3,"file":"index.js","sources":["../../../../src/index.ts"],"sourcesContent":["import fs from \"fs\";\nimport http from \"http\";\nimport path from \"path\";\nimport cors from \"cors\";\nimport express from \"express\";\nimport dotenv from \"dotenv\";\nimport { Server, Transport } from \"@colyseus/core\";\n\n// try to import uWebSockets-express compatibility layer.\nlet uWebSocketsExpressCompatibility: any;\ntry { uWebSocketsExpressCompatibility = require('uwebsockets-express').default;\n} catch (e) {}\n\n/**\n * Do not auto-load `${environment}.env` file when using Arena service.\n */\nif (process.env.NODE_ARENA !== \"true\") {\n    const envFilename = (process.env.NODE_ENV === \"production\")\n        ? \"arena.env\"\n        : `${process.env.NODE_ENV || \"development\"}.env`\n\n    const envPath = path.resolve(path.dirname(require?.main?.filename || process.cwd()), \"..\", envFilename);\n\n    if (fs.existsSync(envPath)) {\n        dotenv.config({ path: envPath });\n        console.log(`‚úÖ ${envFilename} loaded.`);\n\n    } else {\n        console.log(`‚ö†Ô∏è  ${envFilename} not found.`);\n    }\n}\n\nexport interface ArenaOptions {\n    getId?: () => string,\n    initializeTransport?: (options: any) => Transport,\n    initializeExpress?: (app: express.Express) => void,\n    initializeGameServer?: (app: Server) => void,\n    beforeListen?: () => void,\n}\n\nconst ALLOWED_KEYS: Array<keyof ArenaOptions> = [\n  'getId',\n  'initializeTransport',\n  'initializeExpress',\n  'initializeGameServer',\n  'beforeListen'\n];\n\nexport default function (options: ArenaOptions) {\n    for (let key in options) {\n        if (ALLOWED_KEYS.indexOf(key as keyof ArenaOptions) === -1) {\n            throw new Error(`Invalid option '${key}'. Allowed options are: ${ALLOWED_KEYS.join(\", \")}`);\n\n        } else if (typeof(options[key as keyof ArenaOptions]) !== \"function\") {\n            throw new Error(`'${key}' should be a function.`);\n        }\n    }\n\n    return options;\n}\n\n/**\n * Listen on your development environment\n * @param options Arena options\n * @param port Port number to bind Colyseus + Express\n */\nexport async function listen(\n    options: ArenaOptions,\n    port: number = Number(process.env.PORT || 2567)\n) {\n    const transport = await getTransport(options);\n    const gameServer = new Server({\n        transport,\n        // ...?\n    });\n    await options.initializeGameServer?.(gameServer);\n    await options.beforeListen?.();\n\n    gameServer.listen(port);\n\n    const appId = options.getId?.() || \"[ Colyseus ]\";\n    if (appId) { console.log(`üèü  ${appId}`); }\n\n    console.log(`‚öîÔ∏è  Listening on ws://localhost:${ port }`);\n    console.log(\"what...\");\n    return gameServer;\n}\n\n\nexport async function getTransport(options: ArenaOptions) {\n    let transport: Transport;\n\n    if (!options.initializeTransport) {\n        options.initializeTransport = Server.prototype['getDefaultTransport'];\n    }\n\n    let app: express.Express | undefined = express();\n    let server = http.createServer(app);\n\n    transport = await options.initializeTransport({ server });\n\n    if (options.initializeExpress) {\n        // uWebSockets.js + Express compatibility layer.\n        // @ts-ignore\n        if (transport['app']) {\n            if (typeof (uWebSocketsExpressCompatibility) === \"function\") {\n                console.info(\"‚úÖ uWebSockets.js + Express compatibility enabled\");\n                // @ts-ignore\n                server = undefined;\n                // @ts-ignore\n                app = uWebSocketsExpressCompatibility(transport['app']);\n\n            } else {\n                console.warn(\"\");\n                console.warn(\"‚ùå uWebSockets.js + Express compatibility mode couldn't be loaded, run the following command to fix:\");\n                console.warn(\"üëâ npm install --save uwebsockets-express\");\n                console.warn(\"\");\n                app = undefined;\n            }\n        }\n\n        if (app) {\n            // Enable CORS + JSON parsing.\n            app.use(cors());\n            app.use(express.json());\n\n            await options.initializeExpress(app);\n            console.info(\"‚úÖ Express initialized\");\n        }\n    }\n\n    return transport;\n}"],"names":["path","fs","dotenv","Server","express","http","cors"],"mappings":"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"}