{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["import redis from 'redis';\nimport { promisify } from 'util';\n\nimport { Presence } from '@colyseus/core';\n\ntype Callback = (...args: any[]) => void;\n\nexport class RedisPresence implements Presence {\n    public sub: redis.RedisClient;\n    public pub: redis.RedisClient;\n\n    protected subscriptions: { [channel: string]: Callback[] } = {};\n\n    protected subscribeAsync: any;\n    protected unsubscribeAsync: any;\n    protected publishAsync: any;\n\n    protected smembersAsync: any;\n    protected sismemberAsync: any;\n    protected hgetAsync: any;\n    protected hlenAsync: any;\n    protected pubsubAsync: any;\n    protected incrAsync: any;\n    protected decrAsync: any;\n\n    constructor(opts?: redis.ClientOpts) {\n        this.sub = redis.createClient(opts);\n        this.pub = redis.createClient(opts);\n\n        // no listener limit\n        this.sub.setMaxListeners(0);\n\n        // create promisified pub/sub methods.\n        this.subscribeAsync = promisify(this.sub.subscribe).bind(this.sub);\n        this.unsubscribeAsync = promisify(this.sub.unsubscribe).bind(this.sub);\n\n        this.publishAsync = promisify(this.pub.publish).bind(this.pub);\n\n        // create promisified redis methods.\n        this.smembersAsync = promisify(this.pub.smembers).bind(this.pub);\n        this.sismemberAsync = promisify(this.pub.sismember).bind(this.pub);\n        this.hgetAsync = promisify(this.pub.hget).bind(this.pub);\n        this.hlenAsync = promisify(this.pub.hlen).bind(this.pub);\n        this.pubsubAsync = promisify(this.pub.pubsub).bind(this.pub);\n        this.incrAsync = promisify(this.pub.incr).bind(this.pub);\n        this.decrAsync = promisify(this.pub.decr).bind(this.pub);\n    }\n\n    public async subscribe(topic: string, callback: Callback) {\n        if (!this.subscriptions[topic]) {\n          this.subscriptions[topic] = [];\n        }\n\n        this.subscriptions[topic].push(callback);\n\n        if (this.sub.listeners('message').length === 0) {\n          this.sub.addListener('message', this.handleSubscription);\n        }\n\n        await this.subscribeAsync(topic);\n\n        return this;\n    }\n\n    public async unsubscribe(topic: string, callback?: Callback) {\n        const topicCallbacks = this.subscriptions[topic];\n        if (!topicCallbacks) { return; }\n\n        if (callback) {\n          const index = topicCallbacks.indexOf(callback);\n          topicCallbacks.splice(index, 1);\n\n        } else {\n          this.subscriptions[topic] = [];\n        }\n\n        if (this.subscriptions[topic].length === 0) {\n          delete this.subscriptions[topic];\n          await this.unsubscribeAsync(topic);\n        }\n\n        return this;\n    }\n\n    public async publish(topic: string, data: any) {\n        if (data === undefined) {\n            data = false;\n        }\n\n        await this.publishAsync(topic, JSON.stringify(data));\n    }\n\n    public async exists(roomId: string): Promise<boolean> {\n        return (await this.pubsubAsync('channels', roomId)).length > 0;\n    }\n\n    public async setex(key: string, value: string, seconds: number) {\n      return new Promise((resolve) =>\n        this.pub.setex(key, seconds, value, resolve));\n    }\n\n    public async get(key: string) {\n        return new Promise((resolve, reject) => {\n            this.pub.get(key, (err, data) => {\n                if (err) { return reject(err); }\n                resolve(data);\n            });\n        });\n    }\n\n    public async del(roomId: string) {\n        return new Promise((resolve) => {\n            this.pub.del(roomId, resolve);\n        });\n    }\n\n    public async sadd(key: string, value: any) {\n        return new Promise((resolve) => {\n            this.pub.sadd(key, value, resolve);\n        });\n    }\n\n    public async smembers(key: string): Promise<string[]> {\n        return await this.smembersAsync(key);\n    }\n\n    public async sismember(key: string, field: string): Promise<number> {\n        return await this.sismemberAsync(key, field);\n    }\n\n    public async srem(key: string, value: any) {\n        return new Promise((resolve) => {\n            this.pub.srem(key, value, resolve);\n        });\n    }\n\n    public async scard(key: string) {\n        return new Promise((resolve, reject) => {\n            this.pub.scard(key, (err, data) => {\n                if (err) { return reject(err); }\n                resolve(data);\n            });\n        });\n    }\n\n    public async sinter(...keys: string[]) {\n        return new Promise<string[]>((resolve, reject) => {\n            this.pub.sinter(...keys, (err, data) => {\n                if (err) { return reject(err); }\n                resolve(data);\n            });\n        });\n    }\n\n    public async hset(key: string, field: string, value: string) {\n        return new Promise((resolve) => {\n            this.pub.hset(key, field, value, resolve);\n        });\n    }\n\n    public async hincrby(key: string, field: string, value: number) {\n        return new Promise((resolve) => {\n            this.pub.hincrby(key, field, value, resolve);\n        });\n    }\n\n    public async hget(key: string, field: string) {\n        return await this.hgetAsync(key, field);\n    }\n\n    public async hgetall(key: string) {\n        return new Promise<{ [key: string]: string }>((resolve, reject) => {\n            this.pub.hgetall(key, (err, values) => {\n              if (err) { return reject(err); }\n              resolve(values);\n            });\n        });\n    }\n\n    public async hdel(key: string, field: string) {\n        return new Promise((resolve, reject) => {\n            this.pub.hdel(key, field, (err, ok) => {\n              if (err) { return reject(err); }\n              resolve(ok);\n            });\n        });\n    }\n\n    public async hlen(key: string): Promise<number> {\n        return await this.hlenAsync(key);\n    }\n\n    public async incr(key: string): Promise<number> {\n        return await this.incrAsync(key);\n    }\n\n    public async decr(key: string): Promise<number> {\n        return await this.decrAsync(key);\n    }\n\n    public shutdown() {\n        this.sub.quit();\n        this.pub.quit();\n    }\n\n    protected handleSubscription = (channel, message) => {\n        if (this.subscriptions[channel]) {\n          for (let i = 0, l = this.subscriptions[channel].length; i < l; i++) {\n            this.subscriptions[channel][i](JSON.parse(message));\n          }\n        }\n    }\n\n}\n"],"names":["redis","promisify"],"mappings":"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"}