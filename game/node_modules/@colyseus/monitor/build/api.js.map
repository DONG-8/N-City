{"version":3,"file":"api.js","sources":["../src/api.ts"],"sourcesContent":["import { matchMaker } from \"colyseus\";\n\nimport express from \"express\";\nimport osUtils from \"node-os-utils\";\n\nimport { MonitorOptions } from \".\";\n\nconst UNAVAILABLE_ROOM_ERROR = \"@colyseus/monitor: room $roomId is not available anymore.\";\n\nconst DEFAULT_COLUMNS = [\n    'roomId',\n    'name',\n    'clients',\n    'maxClients',\n    'locked',\n    'elapsedTime',\n];\n\nexport function getAPI (opts: Partial<MonitorOptions>) {\n    const api = express.Router();\n\n    api.get(\"/\", async (req: express.Request, res: express.Response) => {\n        try {\n            const rooms: any[] = await matchMaker.query({});\n\n            let connections: number = 0;\n\n            res.json({\n                columns: opts.columns || DEFAULT_COLUMNS,\n                rooms: rooms.map(room => {\n                    const data = room.toJSON();\n\n                    connections += room.clients;\n\n                    // additional data\n                    data.locked = room.locked || false;\n                    data.private = room.private;\n\n                    data.maxClients = `${room.maxClients}`;\n\n                    data.elapsedTime = Date.now() - new Date(room.createdAt).getTime();\n                    return data;\n                }),\n\n                connections,\n                cpu: await osUtils.cpu.usage(),\n                memory: await osUtils.mem.used()\n            });\n        } catch (e) {\n            const message = e.message;\n            console.error(message);\n            res.status(500);\n            res.json({ message });\n        }\n    });\n\n    api.get(\"/room\", async (req: express.Request, res: express.Response) => {\n        const roomId = req.query.roomId as string;\n        try {\n            const inspectData = await matchMaker.remoteRoomCall(roomId, \"getInspectData\");\n            res.json(inspectData);\n        } catch (e) {\n            const message = UNAVAILABLE_ROOM_ERROR.replace(\"$roomId\", roomId);\n            console.error(message);\n            res.status(500);\n            res.json({ message });\n        }\n    });\n\n    api.get(\"/room/call\", async (req: express.Request, res: express.Response) => {\n        const roomId = req.query.roomId as string;\n        const method = req.query.method as string;\n        const args = JSON.parse(req.query.args as string);\n\n        try {\n            const data = await matchMaker.remoteRoomCall(roomId, method, args);\n            res.json(data);\n        } catch (e) {\n            const message = UNAVAILABLE_ROOM_ERROR.replace(\"$roomId\", roomId);\n            console.error(message);\n            res.status(500);\n            res.json({ message });\n        }\n    });\n\n    return api;\n}\n"],"names":["express","matchMaker","osUtils"],"mappings":"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"}