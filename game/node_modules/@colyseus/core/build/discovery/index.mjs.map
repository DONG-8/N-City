{"version":3,"file":"index.mjs","sources":["../../src/discovery/index.ts"],"sourcesContent":["import ip from 'internal-ip';\nimport { Presence } from '../presence/Presence';\n\nconst NODES_SET = 'colyseus:nodes';\nconst DISCOVERY_CHANNEL = 'colyseus:nodes:discovery';\n\nexport interface Node {\n  port: number;\n  processId: string;\n}\n\nasync function getNodeAddress(node: Node) {\n  const host = process.env.SELF_HOSTNAME || await ip.v4();\n  const port = process.env.SELF_PORT || node.port;\n  return `${node.processId}/${host}:${port}`;\n}\n\nexport async function registerNode(presence: Presence, node: Node) {\n  const nodeAddress = await getNodeAddress(node);\n  await presence.sadd(NODES_SET, nodeAddress);\n  await presence.publish(DISCOVERY_CHANNEL, `add,${nodeAddress}`);\n}\n\nexport async function unregisterNode(presence: Presence, node: Node) {\n  const nodeAddress = await getNodeAddress(node);\n  await presence.srem(NODES_SET, nodeAddress);\n  await presence.publish(DISCOVERY_CHANNEL, `remove,${nodeAddress}`);\n}\n"],"names":[],"mappings":";;AAGA,MAAM,SAAS,GAAG,gBAAgB,CAAC;AACnC,MAAM,iBAAiB,GAAG,0BAA0B,CAAC;AAOrD,eAAe,cAAc,CAAC,IAAU;IACtC,MAAM,IAAI,GAAG,OAAO,CAAC,GAAG,CAAC,aAAa,IAAI,MAAM,EAAE,CAAC,EAAE,EAAE,CAAC;IACxD,MAAM,IAAI,GAAG,OAAO,CAAC,GAAG,CAAC,SAAS,IAAI,IAAI,CAAC,IAAI,CAAC;IAChD,OAAO,GAAG,IAAI,CAAC,SAAS,IAAI,IAAI,IAAI,IAAI,EAAE,CAAC;AAC7C,CAAC;AAEM,eAAe,YAAY,CAAC,QAAkB,EAAE,IAAU;IAC/D,MAAM,WAAW,GAAG,MAAM,cAAc,CAAC,IAAI,CAAC,CAAC;IAC/C,MAAM,QAAQ,CAAC,IAAI,CAAC,SAAS,EAAE,WAAW,CAAC,CAAC;IAC5C,MAAM,QAAQ,CAAC,OAAO,CAAC,iBAAiB,EAAE,OAAO,WAAW,EAAE,CAAC,CAAC;AAClE,CAAC;AAEM,eAAe,cAAc,CAAC,QAAkB,EAAE,IAAU;IACjE,MAAM,WAAW,GAAG,MAAM,cAAc,CAAC,IAAI,CAAC,CAAC;IAC/C,MAAM,QAAQ,CAAC,IAAI,CAAC,SAAS,EAAE,WAAW,CAAC,CAAC;IAC5C,MAAM,QAAQ,CAAC,OAAO,CAAC,iBAAiB,EAAE,UAAU,WAAW,EAAE,CAAC,CAAC;AACrE;;;;"}