{"version":3,"file":"command.js","sources":["../../../../../../../node_modules/mongodb/lib/operations/command.js"],"sourcesContent":["'use strict';\n\nconst Aspect = require('./operation').Aspect;\nconst OperationBase = require('./operation').OperationBase;\nconst applyWriteConcern = require('../utils').applyWriteConcern;\nconst debugOptions = require('../utils').debugOptions;\nconst handleCallback = require('../utils').handleCallback;\nconst MongoError = require('../core').MongoError;\nconst ReadPreference = require('../core').ReadPreference;\nconst MongoDBNamespace = require('../utils').MongoDBNamespace;\n\nconst debugFields = [\n  'authSource',\n  'w',\n  'wtimeout',\n  'j',\n  'native_parser',\n  'forceServerObjectId',\n  'serializeFunctions',\n  'raw',\n  'promoteLongs',\n  'promoteValues',\n  'promoteBuffers',\n  'bufferMaxEntries',\n  'numberOfRetries',\n  'retryMiliSeconds',\n  'readPreference',\n  'pkFactory',\n  'parentDb',\n  'promiseLibrary',\n  'noListener'\n];\n\nclass CommandOperation extends OperationBase {\n  constructor(db, options, collection, command) {\n    super(options);\n\n    if (!this.hasAspect(Aspect.WRITE_OPERATION)) {\n      if (collection != null) {\n        this.options.readPreference = ReadPreference.resolve(collection, options);\n      } else {\n        this.options.readPreference = ReadPreference.resolve(db, options);\n      }\n    } else {\n      if (collection != null) {\n        applyWriteConcern(this.options, { db, coll: collection }, this.options);\n      } else {\n        applyWriteConcern(this.options, { db }, this.options);\n      }\n      this.options.readPreference = ReadPreference.primary;\n    }\n\n    this.db = db;\n\n    if (command != null) {\n      this.command = command;\n    }\n\n    if (collection != null) {\n      this.collection = collection;\n    }\n  }\n\n  _buildCommand() {\n    if (this.command != null) {\n      return this.command;\n    }\n  }\n\n  execute(callback) {\n    const db = this.db;\n    const options = Object.assign({}, this.options);\n\n    // Did the user destroy the topology\n    if (db.serverConfig && db.serverConfig.isDestroyed()) {\n      return callback(new MongoError('topology was destroyed'));\n    }\n\n    let command;\n    try {\n      command = this._buildCommand();\n    } catch (e) {\n      return callback(e);\n    }\n\n    // Get the db name we are executing against\n    const dbName = options.dbName || options.authdb || db.databaseName;\n\n    // Convert the readPreference if its not a write\n    if (this.hasAspect(Aspect.WRITE_OPERATION)) {\n      if (options.writeConcern && (!options.session || !options.session.inTransaction())) {\n        command.writeConcern = options.writeConcern;\n      }\n    }\n\n    // Debug information\n    if (db.s.logger.isDebug()) {\n      db.s.logger.debug(\n        `executing command ${JSON.stringify(\n          command\n        )} against ${dbName}.$cmd with options [${JSON.stringify(\n          debugOptions(debugFields, options)\n        )}]`\n      );\n    }\n\n    const namespace =\n      this.namespace != null ? this.namespace : new MongoDBNamespace(dbName, '$cmd');\n\n    // Execute command\n    db.s.topology.command(namespace, command, options, (err, result) => {\n      if (err) return handleCallback(callback, err);\n      if (options.full) return handleCallback(callback, null, result);\n      handleCallback(callback, null, result.result);\n    });\n  }\n}\n\nmodule.exports = CommandOperation;\n"],"names":["require$$0","require$$1","require$$2"],"mappings":"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"}