{"version":3,"file":"ordered.js","sources":["../../../../../../../node_modules/mongodb/lib/bulk/ordered.js"],"sourcesContent":["'use strict';\n\nconst common = require('./common');\nconst BulkOperationBase = common.BulkOperationBase;\nconst Batch = common.Batch;\nconst bson = common.bson;\nconst utils = require('../utils');\nconst toError = utils.toError;\n\n/**\n * Add to internal list of Operations\n *\n * @ignore\n * @param {OrderedBulkOperation} bulkOperation\n * @param {number} docType number indicating the document type\n * @param {object} document\n * @return {OrderedBulkOperation}\n */\nfunction addToOperationsList(bulkOperation, docType, document) {\n  // Get the bsonSize\n  const bsonSize = bson.calculateObjectSize(document, {\n    checkKeys: false,\n\n    // Since we don't know what the user selected for BSON options here,\n    // err on the safe side, and check the size with ignoreUndefined: false.\n    ignoreUndefined: false\n  });\n\n  // Throw error if the doc is bigger than the max BSON size\n  if (bsonSize >= bulkOperation.s.maxBsonObjectSize)\n    throw toError('document is larger than the maximum size ' + bulkOperation.s.maxBsonObjectSize);\n\n  // Create a new batch object if we don't have a current one\n  if (bulkOperation.s.currentBatch == null)\n    bulkOperation.s.currentBatch = new Batch(docType, bulkOperation.s.currentIndex);\n\n  const maxKeySize = bulkOperation.s.maxKeySize;\n\n  // Check if we need to create a new batch\n  if (\n    // New batch if we exceed the max batch op size\n    bulkOperation.s.currentBatchSize + 1 >= bulkOperation.s.maxWriteBatchSize ||\n    // New batch if we exceed the maxBatchSizeBytes. Only matters if batch already has a doc,\n    // since we can't sent an empty batch\n    (bulkOperation.s.currentBatchSize > 0 &&\n      bulkOperation.s.currentBatchSizeBytes + maxKeySize + bsonSize >=\n        bulkOperation.s.maxBatchSizeBytes) ||\n    // New batch if the new op does not have the same op type as the current batch\n    bulkOperation.s.currentBatch.batchType !== docType\n  ) {\n    // Save the batch to the execution stack\n    bulkOperation.s.batches.push(bulkOperation.s.currentBatch);\n\n    // Create a new batch\n    bulkOperation.s.currentBatch = new Batch(docType, bulkOperation.s.currentIndex);\n\n    // Reset the current size trackers\n    bulkOperation.s.currentBatchSize = 0;\n    bulkOperation.s.currentBatchSizeBytes = 0;\n  }\n\n  if (docType === common.INSERT) {\n    bulkOperation.s.bulkResult.insertedIds.push({\n      index: bulkOperation.s.currentIndex,\n      _id: document._id\n    });\n  }\n\n  // We have an array of documents\n  if (Array.isArray(document)) {\n    throw toError('operation passed in cannot be an Array');\n  }\n\n  bulkOperation.s.currentBatch.originalIndexes.push(bulkOperation.s.currentIndex);\n  bulkOperation.s.currentBatch.operations.push(document);\n  bulkOperation.s.currentBatchSize += 1;\n  bulkOperation.s.currentBatchSizeBytes += maxKeySize + bsonSize;\n  bulkOperation.s.currentIndex += 1;\n\n  // Return bulkOperation\n  return bulkOperation;\n}\n\n/**\n * Create a new OrderedBulkOperation instance (INTERNAL TYPE, do not instantiate directly)\n * @class\n * @extends BulkOperationBase\n * @property {number} length Get the number of operations in the bulk.\n * @return {OrderedBulkOperation} a OrderedBulkOperation instance.\n */\nclass OrderedBulkOperation extends BulkOperationBase {\n  constructor(topology, collection, options) {\n    options = options || {};\n    options = Object.assign(options, { addToOperationsList });\n\n    super(topology, collection, options, true);\n  }\n}\n\n/**\n * Returns an unordered batch object\n * @ignore\n */\nfunction initializeOrderedBulkOp(topology, collection, options) {\n  return new OrderedBulkOperation(topology, collection, options);\n}\n\ninitializeOrderedBulkOp.OrderedBulkOperation = OrderedBulkOperation;\nmodule.exports = initializeOrderedBulkOp;\nmodule.exports.Bulk = OrderedBulkOperation;\n"],"names":[],"mappings":"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"}