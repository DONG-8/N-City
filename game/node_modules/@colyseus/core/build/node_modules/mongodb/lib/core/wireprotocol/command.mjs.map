{"version":3,"file":"command.mjs","sources":["../../../../../../../../node_modules/mongodb/lib/core/wireprotocol/command.js"],"sourcesContent":["'use strict';\n\nconst Query = require('../connection/commands').Query;\nconst Msg = require('../connection/msg').Msg;\nconst MongoError = require('../error').MongoError;\nconst getReadPreference = require('./shared').getReadPreference;\nconst isSharded = require('./shared').isSharded;\nconst databaseNamespace = require('./shared').databaseNamespace;\nconst isTransactionCommand = require('../transactions').isTransactionCommand;\nconst applySession = require('../sessions').applySession;\nconst MongoNetworkError = require('../error').MongoNetworkError;\nconst maxWireVersion = require('../utils').maxWireVersion;\n\nfunction isClientEncryptionEnabled(server) {\n  const wireVersion = maxWireVersion(server);\n  return wireVersion && server.autoEncrypter;\n}\n\nfunction command(server, ns, cmd, options, callback) {\n  if (typeof options === 'function') (callback = options), (options = {});\n  options = options || {};\n\n  if (cmd == null) {\n    return callback(new MongoError(`command ${JSON.stringify(cmd)} does not return a cursor`));\n  }\n\n  if (!isClientEncryptionEnabled(server)) {\n    _command(server, ns, cmd, options, callback);\n    return;\n  }\n\n  const wireVersion = maxWireVersion(server);\n  if (typeof wireVersion !== 'number' || wireVersion < 8) {\n    callback(new MongoError('Auto-encryption requires a minimum MongoDB version of 4.2'));\n    return;\n  }\n\n  _cryptCommand(server, ns, cmd, options, callback);\n}\n\nfunction _command(server, ns, cmd, options, callback) {\n  const bson = server.s.bson;\n  const pool = server.s.pool;\n  const readPreference = getReadPreference(cmd, options);\n  const shouldUseOpMsg = supportsOpMsg(server);\n  const session = options.session;\n\n  const serverClusterTime = server.clusterTime;\n  let clusterTime = serverClusterTime;\n  let finalCmd = Object.assign({}, cmd);\n  if (hasSessionSupport(server) && session) {\n    const sessionClusterTime = session.clusterTime;\n    if (\n      serverClusterTime &&\n      serverClusterTime.clusterTime &&\n      sessionClusterTime &&\n      sessionClusterTime.clusterTime &&\n      sessionClusterTime.clusterTime.greaterThan(serverClusterTime.clusterTime)\n    ) {\n      clusterTime = sessionClusterTime;\n    }\n\n    const err = applySession(session, finalCmd, options);\n    if (err) {\n      return callback(err);\n    }\n  }\n\n  if (clusterTime) {\n    // if we have a known cluster time, gossip it\n    finalCmd.$clusterTime = clusterTime;\n  }\n\n  if (isSharded(server) && !shouldUseOpMsg && readPreference && readPreference.mode !== 'primary') {\n    finalCmd = {\n      $query: finalCmd,\n      $readPreference: readPreference.toJSON()\n    };\n  }\n\n  const commandOptions = Object.assign(\n    {\n      command: true,\n      numberToSkip: 0,\n      numberToReturn: -1,\n      checkKeys: false\n    },\n    options\n  );\n\n  // This value is not overridable\n  commandOptions.slaveOk = readPreference.slaveOk();\n\n  const cmdNs = `${databaseNamespace(ns)}.$cmd`;\n  const message = shouldUseOpMsg\n    ? new Msg(bson, cmdNs, finalCmd, commandOptions)\n    : new Query(bson, cmdNs, finalCmd, commandOptions);\n\n  const inTransaction = session && (session.inTransaction() || isTransactionCommand(finalCmd));\n  const commandResponseHandler = inTransaction\n    ? function(err) {\n        // We need to add a TransientTransactionError errorLabel, as stated in the transaction spec.\n        if (\n          err &&\n          err instanceof MongoNetworkError &&\n          !err.hasErrorLabel('TransientTransactionError')\n        ) {\n          err.addErrorLabel('TransientTransactionError');\n        }\n\n        if (\n          !cmd.commitTransaction &&\n          err &&\n          err instanceof MongoError &&\n          err.hasErrorLabel('TransientTransactionError')\n        ) {\n          session.transaction.unpinServer();\n        }\n\n        return callback.apply(null, arguments);\n      }\n    : callback;\n\n  try {\n    pool.write(message, commandOptions, commandResponseHandler);\n  } catch (err) {\n    commandResponseHandler(err);\n  }\n}\n\nfunction hasSessionSupport(topology) {\n  if (topology == null) return false;\n  if (topology.description) {\n    return topology.description.maxWireVersion >= 6;\n  }\n\n  return topology.ismaster == null ? false : topology.ismaster.maxWireVersion >= 6;\n}\n\nfunction supportsOpMsg(topologyOrServer) {\n  const description = topologyOrServer.ismaster\n    ? topologyOrServer.ismaster\n    : topologyOrServer.description;\n\n  if (description == null) {\n    return false;\n  }\n\n  return description.maxWireVersion >= 6 && description.__nodejs_mock_server__ == null;\n}\n\nfunction _cryptCommand(server, ns, cmd, options, callback) {\n  const autoEncrypter = server.autoEncrypter;\n  function commandResponseHandler(err, response) {\n    if (err || response == null) {\n      callback(err, response);\n      return;\n    }\n\n    autoEncrypter.decrypt(response.result, options, (err, decrypted) => {\n      if (err) {\n        callback(err, null);\n        return;\n      }\n\n      response.result = decrypted;\n      response.message.documents = [decrypted];\n      callback(null, response);\n    });\n  }\n\n  autoEncrypter.encrypt(ns, cmd, options, (err, encrypted) => {\n    if (err) {\n      callback(err, null);\n      return;\n    }\n\n    _command(server, ns, encrypted, options, commandResponseHandler);\n  });\n}\n\nmodule.exports = command;\n"],"names":["require$$0","require$$1","require$$2","require$$3","require$$4","require$$5","require$$6"],"mappings":"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"}