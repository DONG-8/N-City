{"version":3,"file":"list_collections.js","sources":["../../../../../../../node_modules/mongodb/lib/operations/list_collections.js"],"sourcesContent":["'use strict';\n\nconst CommandOperationV2 = require('./command_v2');\nconst Aspect = require('./operation').Aspect;\nconst defineAspects = require('./operation').defineAspects;\nconst maxWireVersion = require('../core/utils').maxWireVersion;\nconst CONSTANTS = require('../constants');\n\nconst LIST_COLLECTIONS_WIRE_VERSION = 3;\n\nfunction listCollectionsTransforms(databaseName) {\n  const matching = `${databaseName}.`;\n\n  return {\n    doc: doc => {\n      const index = doc.name.indexOf(matching);\n      // Remove database name if available\n      if (doc.name && index === 0) {\n        doc.name = doc.name.substr(index + matching.length);\n      }\n\n      return doc;\n    }\n  };\n}\n\nclass ListCollectionsOperation extends CommandOperationV2 {\n  constructor(db, filter, options) {\n    super(db, options, { fullResponse: true });\n\n    this.db = db;\n    this.filter = filter;\n    this.nameOnly = !!this.options.nameOnly;\n\n    if (typeof this.options.batchSize === 'number') {\n      this.batchSize = this.options.batchSize;\n    }\n  }\n\n  execute(server, callback) {\n    if (maxWireVersion(server) < LIST_COLLECTIONS_WIRE_VERSION) {\n      let filter = this.filter;\n      const databaseName = this.db.s.namespace.db;\n\n      // If we have legacy mode and have not provided a full db name filter it\n      if (\n        typeof filter.name === 'string' &&\n        !new RegExp('^' + databaseName + '\\\\.').test(filter.name)\n      ) {\n        filter = Object.assign({}, filter);\n        filter.name = this.db.s.namespace.withCollection(filter.name).toString();\n      }\n\n      // No filter, filter by current database\n      if (filter == null) {\n        filter.name = `/${databaseName}/`;\n      }\n\n      // Rewrite the filter to use $and to filter out indexes\n      if (filter.name) {\n        filter = { $and: [{ name: filter.name }, { name: /^((?!\\$).)*$/ }] };\n      } else {\n        filter = { name: /^((?!\\$).)*$/ };\n      }\n\n      const transforms = listCollectionsTransforms(databaseName);\n      server.query(\n        `${databaseName}.${CONSTANTS.SYSTEM_NAMESPACE_COLLECTION}`,\n        { query: filter },\n        { batchSize: this.batchSize || 1000 },\n        {},\n        (err, result) => {\n          if (\n            result &&\n            result.message &&\n            result.message.documents &&\n            Array.isArray(result.message.documents)\n          ) {\n            result.message.documents = result.message.documents.map(transforms.doc);\n          }\n\n          callback(err, result);\n        }\n      );\n\n      return;\n    }\n\n    const command = {\n      listCollections: 1,\n      filter: this.filter,\n      cursor: this.batchSize ? { batchSize: this.batchSize } : {},\n      nameOnly: this.nameOnly\n    };\n\n    return super.executeCommand(server, command, callback);\n  }\n}\n\ndefineAspects(ListCollectionsOperation, [\n  Aspect.READ_OPERATION,\n  Aspect.RETRYABLE,\n  Aspect.EXECUTE_WITH_SELECTION\n]);\n\nmodule.exports = ListCollectionsOperation;\n"],"names":["require$$0","require$$1","CommandOperationV2","CONSTANTS"],"mappings":";;;;;;;AAGA,MAAM,MAAM,GAAGA,SAAsB,CAAC,MAAM,CAAC;AAC7C,MAAM,aAAa,GAAGA,SAAsB,CAAC,aAAa,CAAC;AAC3D,MAAM,cAAc,GAAGC,KAAwB,CAAC,cAAc,CAAC;AACrB;AAC1C;AACA,MAAM,6BAA6B,GAAG,CAAC,CAAC;AACxC;AACA,SAAS,yBAAyB,CAAC,YAAY,EAAE;AACjD,EAAE,MAAM,QAAQ,GAAG,CAAC,EAAE,YAAY,CAAC,CAAC,CAAC,CAAC;AACtC;AACA,EAAE,OAAO;AACT,IAAI,GAAG,EAAE,GAAG,IAAI;AAChB,MAAM,MAAM,KAAK,GAAG,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC;AAC/C;AACA,MAAM,IAAI,GAAG,CAAC,IAAI,IAAI,KAAK,KAAK,CAAC,EAAE;AACnC,QAAQ,GAAG,CAAC,IAAI,GAAG,GAAG,CAAC,IAAI,CAAC,MAAM,CAAC,KAAK,GAAG,QAAQ,CAAC,MAAM,CAAC,CAAC;AAC5D,OAAO;AACP;AACA,MAAM,OAAO,GAAG,CAAC;AACjB,KAAK;AACL,GAAG,CAAC;AACJ,CAAC;AACD;AACA,MAAM,wBAAwB,SAASC,UAAkB,CAAC;AAC1D,EAAE,WAAW,CAAC,EAAE,EAAE,MAAM,EAAE,OAAO,EAAE;AACnC,IAAI,KAAK,CAAC,EAAE,EAAE,OAAO,EAAE,EAAE,YAAY,EAAE,IAAI,EAAE,CAAC,CAAC;AAC/C;AACA,IAAI,IAAI,CAAC,EAAE,GAAG,EAAE,CAAC;AACjB,IAAI,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;AACzB,IAAI,IAAI,CAAC,QAAQ,GAAG,CAAC,CAAC,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC;AAC5C;AACA,IAAI,IAAI,OAAO,IAAI,CAAC,OAAO,CAAC,SAAS,KAAK,QAAQ,EAAE;AACpD,MAAM,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC;AAC9C,KAAK;AACL,GAAG;AACH;AACA,EAAE,OAAO,CAAC,MAAM,EAAE,QAAQ,EAAE;AAC5B,IAAI,IAAI,cAAc,CAAC,MAAM,CAAC,GAAG,6BAA6B,EAAE;AAChE,MAAM,IAAI,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC;AAC/B,MAAM,MAAM,YAAY,GAAG,IAAI,CAAC,EAAE,CAAC,CAAC,CAAC,SAAS,CAAC,EAAE,CAAC;AAClD;AACA;AACA,MAAM;AACN,QAAQ,OAAO,MAAM,CAAC,IAAI,KAAK,QAAQ;AACvC,QAAQ,CAAC,IAAI,MAAM,CAAC,GAAG,GAAG,YAAY,GAAG,KAAK,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC;AACjE,QAAQ;AACR,QAAQ,MAAM,GAAG,MAAM,CAAC,MAAM,CAAC,EAAE,EAAE,MAAM,CAAC,CAAC;AAC3C,QAAQ,MAAM,CAAC,IAAI,GAAG,IAAI,CAAC,EAAE,CAAC,CAAC,CAAC,SAAS,CAAC,cAAc,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,QAAQ,EAAE,CAAC;AACjF,OAAO;AACP;AACA;AACA,MAAM,IAAI,MAAM,IAAI,IAAI,EAAE;AAC1B,QAAQ,MAAM,CAAC,IAAI,GAAG,CAAC,CAAC,EAAE,YAAY,CAAC,CAAC,CAAC,CAAC;AAC1C,OAAO;AACP;AACA;AACA,MAAM,IAAI,MAAM,CAAC,IAAI,EAAE;AACvB,QAAQ,MAAM,GAAG,EAAE,IAAI,EAAE,CAAC,EAAE,IAAI,EAAE,MAAM,CAAC,IAAI,EAAE,EAAE,EAAE,IAAI,EAAE,cAAc,EAAE,CAAC,EAAE,CAAC;AAC7E,OAAO,MAAM;AACb,QAAQ,MAAM,GAAG,EAAE,IAAI,EAAE,cAAc,EAAE,CAAC;AAC1C,OAAO;AACP;AACA,MAAM,MAAM,UAAU,GAAG,yBAAyB,CAAC,YAAY,CAAC,CAAC;AACjE,MAAM,MAAM,CAAC,KAAK;AAClB,QAAQ,CAAC,EAAE,YAAY,CAAC,CAAC,EAAEC,SAAS,CAAC,2BAA2B,CAAC,CAAC;AAClE,QAAQ,EAAE,KAAK,EAAE,MAAM,EAAE;AACzB,QAAQ,EAAE,SAAS,EAAE,IAAI,CAAC,SAAS,IAAI,IAAI,EAAE;AAC7C,QAAQ,EAAE;AACV,QAAQ,CAAC,GAAG,EAAE,MAAM,KAAK;AACzB,UAAU;AACV,YAAY,MAAM;AAClB,YAAY,MAAM,CAAC,OAAO;AAC1B,YAAY,MAAM,CAAC,OAAO,CAAC,SAAS;AACpC,YAAY,KAAK,CAAC,OAAO,CAAC,MAAM,CAAC,OAAO,CAAC,SAAS,CAAC;AACnD,YAAY;AACZ,YAAY,MAAM,CAAC,OAAO,CAAC,SAAS,GAAG,MAAM,CAAC,OAAO,CAAC,SAAS,CAAC,GAAG,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC;AACpF,WAAW;AACX;AACA,UAAU,QAAQ,CAAC,GAAG,EAAE,MAAM,CAAC,CAAC;AAChC,SAAS;AACT,OAAO,CAAC;AACR;AACA,MAAM,OAAO;AACb,KAAK;AACL;AACA,IAAI,MAAM,OAAO,GAAG;AACpB,MAAM,eAAe,EAAE,CAAC;AACxB,MAAM,MAAM,EAAE,IAAI,CAAC,MAAM;AACzB,MAAM,MAAM,EAAE,IAAI,CAAC,SAAS,GAAG,EAAE,SAAS,EAAE,IAAI,CAAC,SAAS,EAAE,GAAG,EAAE;AACjE,MAAM,QAAQ,EAAE,IAAI,CAAC,QAAQ;AAC7B,KAAK,CAAC;AACN;AACA,IAAI,OAAO,KAAK,CAAC,cAAc,CAAC,MAAM,EAAE,OAAO,EAAE,QAAQ,CAAC,CAAC;AAC3D,GAAG;AACH,CAAC;AACD;AACA,aAAa,CAAC,wBAAwB,EAAE;AACxC,EAAE,MAAM,CAAC,cAAc;AACvB,EAAE,MAAM,CAAC,SAAS;AAClB,EAAE,MAAM,CAAC,sBAAsB;AAC/B,CAAC,CAAC,CAAC;AACH;oBACc,GAAG;;;;"}