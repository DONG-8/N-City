{"version":3,"file":"create_indexes.js","sources":["../../../../../../../node_modules/mongodb/lib/operations/create_indexes.js"],"sourcesContent":["'use strict';\n\nconst Aspect = require('./operation').Aspect;\nconst defineAspects = require('./operation').defineAspects;\nconst CommandOperationV2 = require('./command_v2');\nconst MongoError = require('../core').MongoError;\nconst parseIndexOptions = require('../utils').parseIndexOptions;\nconst maxWireVersion = require('../core/utils').maxWireVersion;\n\nconst VALID_INDEX_OPTIONS = new Set([\n  'background',\n  'unique',\n  'name',\n  'partialFilterExpression',\n  'sparse',\n  'expireAfterSeconds',\n  'storageEngine',\n  'collation',\n\n  // text indexes\n  'weights',\n  'default_language',\n  'language_override',\n  'textIndexVersion',\n\n  // 2d-sphere indexes\n  '2dsphereIndexVersion',\n\n  // 2d indexes\n  'bits',\n  'min',\n  'max',\n\n  // geoHaystack Indexes\n  'bucketSize',\n\n  // wildcard indexes\n  'wildcardProjection'\n]);\n\nclass CreateIndexesOperation extends CommandOperationV2 {\n  /**\n   * @ignore\n   */\n  constructor(parent, collection, indexes, options) {\n    super(parent, options);\n    this.collection = collection;\n\n    // createIndex can be called with a variety of styles:\n    //   coll.createIndex('a');\n    //   coll.createIndex({ a: 1 });\n    //   coll.createIndex([['a', 1]]);\n    // createIndexes is always called with an array of index spec objects\n    if (!Array.isArray(indexes) || Array.isArray(indexes[0])) {\n      this.onlyReturnNameOfCreatedIndex = true;\n      // TODO: remove in v4 (breaking change); make createIndex return full response as createIndexes does\n\n      const indexParameters = parseIndexOptions(indexes);\n      // Generate the index name\n      const name = typeof options.name === 'string' ? options.name : indexParameters.name;\n      // Set up the index\n      const indexSpec = { name, key: indexParameters.fieldHash };\n      // merge valid index options into the index spec\n      for (let optionName in options) {\n        if (VALID_INDEX_OPTIONS.has(optionName)) {\n          indexSpec[optionName] = options[optionName];\n        }\n      }\n      this.indexes = [indexSpec];\n      return;\n    }\n\n    this.indexes = indexes;\n  }\n\n  /**\n   * @ignore\n   */\n  execute(server, callback) {\n    const options = this.options;\n    const indexes = this.indexes;\n\n    const serverWireVersion = maxWireVersion(server);\n\n    // Ensure we generate the correct name if the parameter is not set\n    for (let i = 0; i < indexes.length; i++) {\n      // Did the user pass in a collation, check if our write server supports it\n      if (indexes[i].collation && serverWireVersion < 5) {\n        callback(\n          new MongoError(\n            `Server ${server.name}, which reports wire version ${serverWireVersion}, does not support collation`\n          )\n        );\n        return;\n      }\n\n      if (indexes[i].name == null) {\n        const keys = [];\n\n        for (let name in indexes[i].key) {\n          keys.push(`${name}_${indexes[i].key[name]}`);\n        }\n\n        // Set the name\n        indexes[i].name = keys.join('_');\n      }\n    }\n\n    const cmd = { createIndexes: this.collection, indexes };\n\n    if (options.commitQuorum != null) {\n      if (serverWireVersion < 9) {\n        callback(\n          new MongoError('`commitQuorum` option for `createIndexes` not supported on servers < 4.4')\n        );\n        return;\n      }\n      cmd.commitQuorum = options.commitQuorum;\n    }\n\n    // collation is set on each index, it should not be defined at the root\n    this.options.collation = undefined;\n\n    super.executeCommand(server, cmd, (err, result) => {\n      if (err) {\n        callback(err);\n        return;\n      }\n\n      callback(null, this.onlyReturnNameOfCreatedIndex ? indexes[0].name : result);\n    });\n  }\n}\n\ndefineAspects(CreateIndexesOperation, [Aspect.WRITE_OPERATION, Aspect.EXECUTE_WITH_SELECTION]);\n\nmodule.exports = CreateIndexesOperation;\n"],"names":["require$$0","require$$1","require$$2","require$$3","CommandOperationV2"],"mappings":"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"}