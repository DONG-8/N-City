{"version":3,"file":"gssapi.mjs","sources":["../../../../../../../../node_modules/mongodb/lib/core/auth/gssapi.js"],"sourcesContent":["'use strict';\nconst dns = require('dns');\n\nconst AuthProvider = require('./auth_provider').AuthProvider;\nconst retrieveKerberos = require('../utils').retrieveKerberos;\nconst MongoError = require('../error').MongoError;\n\nlet kerberos;\n\nclass GSSAPI extends AuthProvider {\n  auth(authContext, callback) {\n    const connection = authContext.connection;\n    const credentials = authContext.credentials;\n    if (credentials == null) return callback(new MongoError('credentials required'));\n    const username = credentials.username;\n    function externalCommand(command, cb) {\n      return connection.command('$external.$cmd', command, cb);\n    }\n    makeKerberosClient(authContext, (err, client) => {\n      if (err) return callback(err);\n      if (client == null) return callback(new MongoError('gssapi client missing'));\n      client.step('', (err, payload) => {\n        if (err) return callback(err);\n        externalCommand(saslStart(payload), (err, response) => {\n          if (err) return callback(err);\n          const result = response.result;\n          negotiate(client, 10, result.payload, (err, payload) => {\n            if (err) return callback(err);\n            externalCommand(saslContinue(payload, result.conversationId), (err, response) => {\n              if (err) return callback(err);\n              const result = response.result;\n              finalize(client, username, result.payload, (err, payload) => {\n                if (err) return callback(err);\n                externalCommand(\n                  {\n                    saslContinue: 1,\n                    conversationId: result.conversationId,\n                    payload\n                  },\n                  (err, result) => {\n                    if (err) return callback(err);\n                    callback(undefined, result);\n                  }\n                );\n              });\n            });\n          });\n        });\n      });\n    });\n  }\n}\nmodule.exports = GSSAPI;\n\nfunction makeKerberosClient(authContext, callback) {\n  const host = authContext.options.host;\n  const port = authContext.options.port;\n  const credentials = authContext.credentials;\n  if (!host || !port || !credentials) {\n    return callback(\n      new MongoError(\n        `Connection must specify: ${host ? 'host' : ''}, ${port ? 'port' : ''}, ${\n          credentials ? 'host' : 'credentials'\n        }.`\n      )\n    );\n  }\n  if (kerberos == null) {\n    try {\n      kerberos = retrieveKerberos();\n    } catch (e) {\n      return callback(e);\n    }\n  }\n  const username = credentials.username;\n  const password = credentials.password;\n  const mechanismProperties = credentials.mechanismProperties;\n  const serviceName =\n    mechanismProperties['gssapiservicename'] ||\n    mechanismProperties['gssapiServiceName'] ||\n    'mongodb';\n  performGssapiCanonicalizeHostName(host, mechanismProperties, (err, host) => {\n    if (err) return callback(err);\n    const initOptions = {};\n    if (password != null) {\n      Object.assign(initOptions, { user: username, password: password });\n    }\n    kerberos.initializeClient(\n      `${serviceName}${process.platform === 'win32' ? '/' : '@'}${host}`,\n      initOptions,\n      (err, client) => {\n        if (err) return callback(new MongoError(err));\n        callback(null, client);\n      }\n    );\n  });\n}\n\nfunction saslStart(payload) {\n  return {\n    saslStart: 1,\n    mechanism: 'GSSAPI',\n    payload,\n    autoAuthorize: 1\n  };\n}\nfunction saslContinue(payload, conversationId) {\n  return {\n    saslContinue: 1,\n    conversationId,\n    payload\n  };\n}\nfunction negotiate(client, retries, payload, callback) {\n  client.step(payload, (err, response) => {\n    // Retries exhausted, raise error\n    if (err && retries === 0) return callback(err);\n    // Adjust number of retries and call step again\n    if (err) return negotiate(client, retries - 1, payload, callback);\n    // Return the payload\n    callback(undefined, response || '');\n  });\n}\nfunction finalize(client, user, payload, callback) {\n  // GSS Client Unwrap\n  client.unwrap(payload, (err, response) => {\n    if (err) return callback(err);\n    // Wrap the response\n    client.wrap(response || '', { user }, (err, wrapped) => {\n      if (err) return callback(err);\n      // Return the payload\n      callback(undefined, wrapped);\n    });\n  });\n}\nfunction performGssapiCanonicalizeHostName(host, mechanismProperties, callback) {\n  const canonicalizeHostName =\n    typeof mechanismProperties.gssapiCanonicalizeHostName === 'boolean'\n      ? mechanismProperties.gssapiCanonicalizeHostName\n      : false;\n  if (!canonicalizeHostName) return callback(undefined, host);\n  // Attempt to resolve the host name\n  dns.resolveCname(host, (err, r) => {\n    if (err) return callback(err);\n    // Get the first resolve host id\n    if (Array.isArray(r) && r.length > 0) {\n      return callback(undefined, r[0]);\n    }\n    callback(undefined, host);\n  });\n}\n"],"names":["require$$0","require$$1","require$$2"],"mappings":"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"}