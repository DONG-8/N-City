import command_v2 from './command_v2.mjs';
import operation from './operation.mjs';
import utils from '../core/utils.mjs';

const Aspect = operation.Aspect;
const defineAspects = operation.defineAspects;
const maxWireVersion = utils.maxWireVersion;

const LIST_INDEXES_WIRE_VERSION = 3;

class ListIndexesOperation extends command_v2 {
  constructor(collection, options) {
    super(collection, options, { fullResponse: true });

    this.collectionNamespace = collection.s.namespace;
  }

  execute(server, callback) {
    const serverWireVersion = maxWireVersion(server);
    if (serverWireVersion < LIST_INDEXES_WIRE_VERSION) {
      const systemIndexesNS = this.collectionNamespace.withCollection('system.indexes').toString();
      const collectionNS = this.collectionNamespace.toString();

      server.query(systemIndexesNS, { query: { ns: collectionNS } }, {}, this.options, callback);
      return;
    }

    const cursor = this.options.batchSize ? { batchSize: this.options.batchSize } : {};
    super.executeCommand(
      server,
      { listIndexes: this.collectionNamespace.collection, cursor },
      callback
    );
  }
}

defineAspects(ListIndexesOperation, [
  Aspect.READ_OPERATION,
  Aspect.RETRYABLE,
  Aspect.EXECUTE_WITH_SELECTION
]);

var list_indexes = ListIndexesOperation;

export default list_indexes;
//# sourceMappingURL=list_indexes.mjs.map
