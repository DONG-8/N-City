{"version":3,"file":"find_and_modify.mjs","sources":["../../../../../../../node_modules/mongodb/lib/operations/find_and_modify.js"],"sourcesContent":["'use strict';\n\nconst OperationBase = require('./operation').OperationBase;\nconst applyRetryableWrites = require('../utils').applyRetryableWrites;\nconst applyWriteConcern = require('../utils').applyWriteConcern;\nconst decorateWithCollation = require('../utils').decorateWithCollation;\nconst executeCommand = require('./db_ops').executeCommand;\nconst formattedOrderClause = require('../utils').formattedOrderClause;\nconst handleCallback = require('../utils').handleCallback;\nconst ReadPreference = require('../core').ReadPreference;\nconst maxWireVersion = require('../core/utils').maxWireVersion;\nconst MongoError = require('../error').MongoError;\nconst Aspect = require('./operation').Aspect;\nconst defineAspects = require('./operation').defineAspects;\nconst decorateWithExplain = require('../utils').decorateWithExplain;\n\nclass FindAndModifyOperation extends OperationBase {\n  constructor(collection, query, sort, doc, options) {\n    super(options);\n\n    this.collection = collection;\n    this.query = query;\n    this.sort = sort;\n    this.doc = doc;\n  }\n\n  execute(callback) {\n    const coll = this.collection;\n    const query = this.query;\n    const sort = formattedOrderClause(this.sort);\n    const doc = this.doc;\n    let options = this.options;\n\n    // Create findAndModify command object\n    let queryObject = {\n      findAndModify: coll.collectionName,\n      query: query\n    };\n\n    if (sort) {\n      queryObject.sort = sort;\n    }\n\n    queryObject.new = options.new ? true : false;\n    queryObject.remove = options.remove ? true : false;\n    queryObject.upsert = options.upsert ? true : false;\n\n    const projection = options.projection || options.fields;\n\n    if (projection) {\n      queryObject.fields = projection;\n    }\n\n    if (options.arrayFilters) {\n      queryObject.arrayFilters = options.arrayFilters;\n    }\n\n    if (doc && !options.remove) {\n      queryObject.update = doc;\n    }\n\n    if (options.maxTimeMS) queryObject.maxTimeMS = options.maxTimeMS;\n\n    // Either use override on the function, or go back to default on either the collection\n    // level or db\n    options.serializeFunctions = options.serializeFunctions || coll.s.serializeFunctions;\n\n    // No check on the documents\n    options.checkKeys = false;\n\n    // Final options for retryable writes and write concern\n    options = applyRetryableWrites(options, coll.s.db);\n    options = applyWriteConcern(options, { db: coll.s.db, collection: coll }, options);\n\n    // Decorate the findAndModify command with the write Concern\n    if (options.writeConcern) {\n      queryObject.writeConcern = options.writeConcern;\n    }\n\n    // Have we specified bypassDocumentValidation\n    if (options.bypassDocumentValidation === true) {\n      queryObject.bypassDocumentValidation = options.bypassDocumentValidation;\n    }\n\n    options.readPreference = ReadPreference.primary;\n\n    // Have we specified collation\n    try {\n      decorateWithCollation(queryObject, coll, options);\n    } catch (err) {\n      return callback(err, null);\n    }\n\n    if (options.hint) {\n      // TODO: once this method becomes a CommandOperationV2 we will have the server\n      // in place to check.\n      const unacknowledgedWrite = options.writeConcern && options.writeConcern.w === 0;\n      if (unacknowledgedWrite || maxWireVersion(coll.s.topology) < 8) {\n        callback(\n          new MongoError('The current topology does not support a hint on findAndModify commands')\n        );\n\n        return;\n      }\n\n      queryObject.hint = options.hint;\n    }\n\n    if (this.explain) {\n      if (maxWireVersion(coll.s.topology) < 4) {\n        callback(new MongoError(`server does not support explain on findAndModify`));\n        return;\n      }\n      queryObject = decorateWithExplain(queryObject, this.explain);\n    }\n\n    // Execute the command\n    executeCommand(coll.s.db, queryObject, options, (err, result) => {\n      if (err) return handleCallback(callback, err, null);\n\n      return handleCallback(callback, null, result);\n    });\n  }\n}\n\ndefineAspects(FindAndModifyOperation, [Aspect.EXPLAINABLE]);\n\nmodule.exports = FindAndModifyOperation;\n"],"names":["require$$0","require$$1","require$$2","require$$3","require$$4","require$$5"],"mappings":"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"}