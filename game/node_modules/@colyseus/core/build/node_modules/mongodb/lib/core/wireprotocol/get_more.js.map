{"version":3,"file":"get_more.js","sources":["../../../../../../../../node_modules/mongodb/lib/core/wireprotocol/get_more.js"],"sourcesContent":["'use strict';\n\nconst GetMore = require('../connection/commands').GetMore;\nconst retrieveBSON = require('../connection/utils').retrieveBSON;\nconst MongoError = require('../error').MongoError;\nconst MongoNetworkError = require('../error').MongoNetworkError;\nconst BSON = retrieveBSON();\nconst Long = BSON.Long;\nconst collectionNamespace = require('./shared').collectionNamespace;\nconst maxWireVersion = require('../utils').maxWireVersion;\nconst applyCommonQueryOptions = require('./shared').applyCommonQueryOptions;\nconst command = require('./command');\n\nfunction getMore(server, ns, cursorState, batchSize, options, callback) {\n  options = options || {};\n\n  const wireVersion = maxWireVersion(server);\n  function queryCallback(err, result) {\n    if (err) return callback(err);\n    const response = result.message;\n\n    // If we have a timed out query or a cursor that was killed\n    if (response.cursorNotFound) {\n      return callback(new MongoNetworkError('cursor killed or timed out'), null);\n    }\n\n    if (wireVersion < 4) {\n      const cursorId =\n        typeof response.cursorId === 'number'\n          ? Long.fromNumber(response.cursorId)\n          : response.cursorId;\n\n      cursorState.documents = response.documents;\n      cursorState.cursorId = cursorId;\n\n      callback(null, null, response.connection);\n      return;\n    }\n\n    // We have an error detected\n    if (response.documents[0].ok === 0) {\n      return callback(new MongoError(response.documents[0]));\n    }\n\n    // Ensure we have a Long valid cursor id\n    const cursorId =\n      typeof response.documents[0].cursor.id === 'number'\n        ? Long.fromNumber(response.documents[0].cursor.id)\n        : response.documents[0].cursor.id;\n\n    cursorState.documents = response.documents[0].cursor.nextBatch;\n    cursorState.cursorId = cursorId;\n\n    callback(null, response.documents[0], response.connection);\n  }\n\n  if (wireVersion < 4) {\n    const bson = server.s.bson;\n    const getMoreOp = new GetMore(bson, ns, cursorState.cursorId, { numberToReturn: batchSize });\n    const queryOptions = applyCommonQueryOptions({}, cursorState);\n    server.s.pool.write(getMoreOp, queryOptions, queryCallback);\n    return;\n  }\n\n  const cursorId =\n    cursorState.cursorId instanceof Long\n      ? cursorState.cursorId\n      : Long.fromNumber(cursorState.cursorId);\n\n  const getMoreCmd = {\n    getMore: cursorId,\n    collection: collectionNamespace(ns),\n    batchSize: Math.abs(batchSize)\n  };\n\n  if (cursorState.cmd.tailable && typeof cursorState.cmd.maxAwaitTimeMS === 'number') {\n    getMoreCmd.maxTimeMS = cursorState.cmd.maxAwaitTimeMS;\n  }\n\n  const commandOptions = Object.assign(\n    {\n      returnFieldSelector: null,\n      documentsReturnedIn: 'nextBatch'\n    },\n    options\n  );\n\n  if (cursorState.session) {\n    commandOptions.session = cursorState.session;\n  }\n\n  command(server, ns, getMoreCmd, commandOptions, queryCallback);\n}\n\nmodule.exports = getMore;\n"],"names":["require$$0","require$$1","require$$2","require$$3","require$$4"],"mappings":";;;;;;;;;AAEA,MAAM,OAAO,GAAGA,QAAiC,CAAC,OAAO,CAAC;AAC1D,MAAM,YAAY,GAAGC,KAA8B,CAAC,YAAY,CAAC;AACjE,MAAM,UAAU,GAAGC,KAAmB,CAAC,UAAU,CAAC;AAClD,MAAM,iBAAiB,GAAGA,KAAmB,CAAC,iBAAiB,CAAC;AAChE,MAAM,IAAI,GAAG,YAAY,EAAE,CAAC;AAC5B,MAAM,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC;AACvB,MAAM,mBAAmB,GAAGC,MAAmB,CAAC,mBAAmB,CAAC;AACpE,MAAM,cAAc,GAAGC,OAAmB,CAAC,cAAc,CAAC;AAC1D,MAAM,uBAAuB,GAAGD,MAAmB,CAAC,uBAAuB,CAAC;AACvC;AACrC;AACA,SAAS,OAAO,CAAC,MAAM,EAAE,EAAE,EAAE,WAAW,EAAE,SAAS,EAAE,OAAO,EAAE,QAAQ,EAAE;AACxE,EAAE,OAAO,GAAG,OAAO,IAAI,EAAE,CAAC;AAC1B;AACA,EAAE,MAAM,WAAW,GAAG,cAAc,CAAC,MAAM,CAAC,CAAC;AAC7C,EAAE,SAAS,aAAa,CAAC,GAAG,EAAE,MAAM,EAAE;AACtC,IAAI,IAAI,GAAG,EAAE,OAAO,QAAQ,CAAC,GAAG,CAAC,CAAC;AAClC,IAAI,MAAM,QAAQ,GAAG,MAAM,CAAC,OAAO,CAAC;AACpC;AACA;AACA,IAAI,IAAI,QAAQ,CAAC,cAAc,EAAE;AACjC,MAAM,OAAO,QAAQ,CAAC,IAAI,iBAAiB,CAAC,4BAA4B,CAAC,EAAE,IAAI,CAAC,CAAC;AACjF,KAAK;AACL;AACA,IAAI,IAAI,WAAW,GAAG,CAAC,EAAE;AACzB,MAAM,MAAM,QAAQ;AACpB,QAAQ,OAAO,QAAQ,CAAC,QAAQ,KAAK,QAAQ;AAC7C,YAAY,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAC,QAAQ,CAAC;AAC9C,YAAY,QAAQ,CAAC,QAAQ,CAAC;AAC9B;AACA,MAAM,WAAW,CAAC,SAAS,GAAG,QAAQ,CAAC,SAAS,CAAC;AACjD,MAAM,WAAW,CAAC,QAAQ,GAAG,QAAQ,CAAC;AACtC;AACA,MAAM,QAAQ,CAAC,IAAI,EAAE,IAAI,EAAE,QAAQ,CAAC,UAAU,CAAC,CAAC;AAChD,MAAM,OAAO;AACb,KAAK;AACL;AACA;AACA,IAAI,IAAI,QAAQ,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,EAAE;AACxC,MAAM,OAAO,QAAQ,CAAC,IAAI,UAAU,CAAC,QAAQ,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;AAC7D,KAAK;AACL;AACA;AACA,IAAI,MAAM,QAAQ;AAClB,MAAM,OAAO,QAAQ,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC,EAAE,KAAK,QAAQ;AACzD,UAAU,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC,EAAE,CAAC;AAC1D,UAAU,QAAQ,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC,EAAE,CAAC;AAC1C;AACA,IAAI,WAAW,CAAC,SAAS,GAAG,QAAQ,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC,SAAS,CAAC;AACnE,IAAI,WAAW,CAAC,QAAQ,GAAG,QAAQ,CAAC;AACpC;AACA,IAAI,QAAQ,CAAC,IAAI,EAAE,QAAQ,CAAC,SAAS,CAAC,CAAC,CAAC,EAAE,QAAQ,CAAC,UAAU,CAAC,CAAC;AAC/D,GAAG;AACH;AACA,EAAE,IAAI,WAAW,GAAG,CAAC,EAAE;AACvB,IAAI,MAAM,IAAI,GAAG,MAAM,CAAC,CAAC,CAAC,IAAI,CAAC;AAC/B,IAAI,MAAM,SAAS,GAAG,IAAI,OAAO,CAAC,IAAI,EAAE,EAAE,EAAE,WAAW,CAAC,QAAQ,EAAE,EAAE,cAAc,EAAE,SAAS,EAAE,CAAC,CAAC;AACjG,IAAI,MAAM,YAAY,GAAG,uBAAuB,CAAC,EAAE,EAAE,WAAW,CAAC,CAAC;AAClE,IAAI,MAAM,CAAC,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,SAAS,EAAE,YAAY,EAAE,aAAa,CAAC,CAAC;AAChE,IAAI,OAAO;AACX,GAAG;AACH;AACA,EAAE,MAAM,QAAQ;AAChB,IAAI,WAAW,CAAC,QAAQ,YAAY,IAAI;AACxC,QAAQ,WAAW,CAAC,QAAQ;AAC5B,QAAQ,IAAI,CAAC,UAAU,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC;AAC9C;AACA,EAAE,MAAM,UAAU,GAAG;AACrB,IAAI,OAAO,EAAE,QAAQ;AACrB,IAAI,UAAU,EAAE,mBAAmB,CAAC,EAAE,CAAC;AACvC,IAAI,SAAS,EAAE,IAAI,CAAC,GAAG,CAAC,SAAS,CAAC;AAClC,GAAG,CAAC;AACJ;AACA,EAAE,IAAI,WAAW,CAAC,GAAG,CAAC,QAAQ,IAAI,OAAO,WAAW,CAAC,GAAG,CAAC,cAAc,KAAK,QAAQ,EAAE;AACtF,IAAI,UAAU,CAAC,SAAS,GAAG,WAAW,CAAC,GAAG,CAAC,cAAc,CAAC;AAC1D,GAAG;AACH;AACA,EAAE,MAAM,cAAc,GAAG,MAAM,CAAC,MAAM;AACtC,IAAI;AACJ,MAAM,mBAAmB,EAAE,IAAI;AAC/B,MAAM,mBAAmB,EAAE,WAAW;AACtC,KAAK;AACL,IAAI,OAAO;AACX,GAAG,CAAC;AACJ;AACA,EAAE,IAAI,WAAW,CAAC,OAAO,EAAE;AAC3B,IAAI,cAAc,CAAC,OAAO,GAAG,WAAW,CAAC,OAAO,CAAC;AACjD,GAAG;AACH;AACA,EAAE,OAAO,CAAC,MAAM,EAAE,EAAE,EAAE,UAAU,EAAE,cAAc,EAAE,aAAa,CAAC,CAAC;AACjE,CAAC;AACD;YACc,GAAG;;;;"}