{"version":3,"file":"cursor_ops.mjs","sources":["../../../../../../../node_modules/mongodb/lib/operations/cursor_ops.js"],"sourcesContent":["'use strict';\n\nconst buildCountCommand = require('./collection_ops').buildCountCommand;\nconst handleCallback = require('../utils').handleCallback;\nconst MongoError = require('../core').MongoError;\nconst push = Array.prototype.push;\nconst CursorState = require('../core/cursor').CursorState;\n\n/**\n * Get the count of documents for this cursor.\n *\n * @method\n * @param {Cursor} cursor The Cursor instance on which to count.\n * @param {boolean} [applySkipLimit=true] Specifies whether the count command apply limit and skip settings should be applied on the cursor or in the provided options.\n * @param {object} [options] Optional settings. See Cursor.prototype.count for a list of options.\n * @param {Cursor~countResultCallback} [callback] The result callback.\n */\nfunction count(cursor, applySkipLimit, opts, callback) {\n  if (applySkipLimit) {\n    if (typeof cursor.cursorSkip() === 'number') opts.skip = cursor.cursorSkip();\n    if (typeof cursor.cursorLimit() === 'number') opts.limit = cursor.cursorLimit();\n  }\n\n  // Ensure we have the right read preference inheritance\n  if (opts.readPreference) {\n    cursor.setReadPreference(opts.readPreference);\n  }\n\n  if (\n    typeof opts.maxTimeMS !== 'number' &&\n    cursor.cmd &&\n    typeof cursor.cmd.maxTimeMS === 'number'\n  ) {\n    opts.maxTimeMS = cursor.cmd.maxTimeMS;\n  }\n\n  let options = {};\n  options.skip = opts.skip;\n  options.limit = opts.limit;\n  options.hint = opts.hint;\n  options.maxTimeMS = opts.maxTimeMS;\n\n  // Command\n  options.collectionName = cursor.namespace.collection;\n\n  let command;\n  try {\n    command = buildCountCommand(cursor, cursor.cmd.query, options);\n  } catch (err) {\n    return callback(err);\n  }\n\n  // Set cursor server to the same as the topology\n  cursor.server = cursor.topology.s.coreTopology;\n\n  // Execute the command\n  cursor.topology.command(\n    cursor.namespace.withCollection('$cmd'),\n    command,\n    cursor.options,\n    (err, result) => {\n      callback(err, result ? result.result.n : null);\n    }\n  );\n}\n\n/**\n * Iterates over all the documents for this cursor. See Cursor.prototype.each for more information.\n *\n * @method\n * @deprecated\n * @param {Cursor} cursor The Cursor instance on which to run.\n * @param {Cursor~resultCallback} callback The result callback.\n */\nfunction each(cursor, callback) {\n  if (!callback) throw MongoError.create({ message: 'callback is mandatory', driver: true });\n  if (cursor.isNotified()) return;\n  if (cursor.s.state === CursorState.CLOSED || cursor.isDead()) {\n    return handleCallback(\n      callback,\n      MongoError.create({ message: 'Cursor is closed', driver: true })\n    );\n  }\n\n  if (cursor.s.state === CursorState.INIT) {\n    cursor.s.state = CursorState.OPEN;\n  }\n\n  // Define function to avoid global scope escape\n  let fn = null;\n  // Trampoline all the entries\n  if (cursor.bufferedCount() > 0) {\n    while ((fn = loop(cursor, callback))) fn(cursor, callback);\n    each(cursor, callback);\n  } else {\n    cursor.next((err, item) => {\n      if (err) return handleCallback(callback, err);\n      if (item == null) {\n        return cursor.close({ skipKillCursors: true }, () => handleCallback(callback, null, null));\n      }\n\n      if (handleCallback(callback, null, item) === false) return;\n      each(cursor, callback);\n    });\n  }\n}\n\n// Trampoline emptying the number of retrieved items\n// without incurring a nextTick operation\nfunction loop(cursor, callback) {\n  // No more items we are done\n  if (cursor.bufferedCount() === 0) return;\n  // Get the next document\n  cursor._next(callback);\n  // Loop\n  return loop;\n}\n\n/**\n * Returns an array of documents. See Cursor.prototype.toArray for more information.\n *\n * @method\n * @param {Cursor} cursor The Cursor instance from which to get the next document.\n * @param {Cursor~toArrayResultCallback} [callback] The result callback.\n */\nfunction toArray(cursor, callback) {\n  const items = [];\n\n  // Reset cursor\n  cursor.rewind();\n  cursor.s.state = CursorState.INIT;\n\n  // Fetch all the documents\n  const fetchDocs = () => {\n    cursor._next((err, doc) => {\n      if (err) {\n        return handleCallback(callback, err);\n      }\n\n      if (doc == null) {\n        return cursor.close({ skipKillCursors: true }, () => handleCallback(callback, null, items));\n      }\n\n      // Add doc to items\n      items.push(doc);\n\n      // Get all buffered objects\n      if (cursor.bufferedCount() > 0) {\n        let docs = cursor.readBufferedDocuments(cursor.bufferedCount());\n\n        // Transform the doc if transform method added\n        if (cursor.s.transforms && typeof cursor.s.transforms.doc === 'function') {\n          docs = docs.map(cursor.s.transforms.doc);\n        }\n\n        push.apply(items, docs);\n      }\n\n      // Attempt a fetch\n      fetchDocs();\n    });\n  };\n\n  fetchDocs();\n}\n\nmodule.exports = { count, each, toArray };\n"],"names":["require$$0","require$$1","require$$2","require$$3"],"mappings":"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"}