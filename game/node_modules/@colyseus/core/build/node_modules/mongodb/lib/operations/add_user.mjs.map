{"version":3,"file":"add_user.mjs","sources":["../../../../../../../node_modules/mongodb/lib/operations/add_user.js"],"sourcesContent":["'use strict';\n\nconst Aspect = require('./operation').Aspect;\nconst CommandOperation = require('./command');\nconst defineAspects = require('./operation').defineAspects;\nconst crypto = require('crypto');\nconst handleCallback = require('../utils').handleCallback;\nconst toError = require('../utils').toError;\nconst emitWarning = require('../utils').emitWarning;\n\nclass AddUserOperation extends CommandOperation {\n  constructor(db, username, password, options) {\n    super(db, options);\n\n    this.username = username;\n    this.password = password;\n  }\n\n  _buildCommand() {\n    const db = this.db;\n    const username = this.username;\n    const password = this.password;\n    const options = this.options;\n\n    // Get additional values\n    let roles = [];\n    if (Array.isArray(options.roles)) roles = options.roles;\n    if (typeof options.roles === 'string') roles = [options.roles];\n\n    // If not roles defined print deprecated message\n    // TODO: handle deprecation properly\n    if (roles.length === 0) {\n      emitWarning('Creating a user without roles is deprecated in MongoDB >= 2.6');\n    }\n\n    // Check the db name and add roles if needed\n    if (\n      (db.databaseName.toLowerCase() === 'admin' || options.dbName === 'admin') &&\n      !Array.isArray(options.roles)\n    ) {\n      roles = ['root'];\n    } else if (!Array.isArray(options.roles)) {\n      roles = ['dbOwner'];\n    }\n\n    const digestPassword = db.s.topology.lastIsMaster().maxWireVersion >= 7;\n\n    let userPassword = password;\n\n    if (!digestPassword) {\n      // Use node md5 generator\n      const md5 = crypto.createHash('md5');\n      // Generate keys used for authentication\n      md5.update(username + ':mongo:' + password);\n      userPassword = md5.digest('hex');\n    }\n\n    // Build the command to execute\n    const command = {\n      createUser: username,\n      customData: options.customData || {},\n      roles: roles,\n      digestPassword\n    };\n\n    // No password\n    if (typeof password === 'string') {\n      command.pwd = userPassword;\n    }\n\n    return command;\n  }\n\n  execute(callback) {\n    const options = this.options;\n\n    // Error out if digestPassword set\n    if (options.digestPassword != null) {\n      return callback(\n        toError(\n          \"The digestPassword option is not supported via add_user. Please use db.command('createUser', ...) instead for this option.\"\n        )\n      );\n    }\n\n    // Attempt to execute auth command\n    super.execute((err, r) => {\n      if (!err) {\n        return handleCallback(callback, err, r);\n      }\n\n      return handleCallback(callback, err, null);\n    });\n  }\n}\n\ndefineAspects(AddUserOperation, Aspect.WRITE_OPERATION);\n\nmodule.exports = AddUserOperation;\n"],"names":["require$$0","require$$1","CommandOperation"],"mappings":"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"}