{"version":3,"file":"command_v2.mjs","sources":["../../../../../../../node_modules/mongodb/lib/operations/command_v2.js"],"sourcesContent":["'use strict';\n\nconst Aspect = require('./operation').Aspect;\nconst OperationBase = require('./operation').OperationBase;\nconst ReadPreference = require('../core').ReadPreference;\nconst ReadConcern = require('../read_concern');\nconst WriteConcern = require('../write_concern');\nconst maxWireVersion = require('../core/utils').maxWireVersion;\nconst decorateWithExplain = require('../utils').decorateWithExplain;\nconst commandSupportsReadConcern = require('../core/sessions').commandSupportsReadConcern;\nconst MongoError = require('../core/error').MongoError;\n\nconst SUPPORTS_WRITE_CONCERN_AND_COLLATION = 5;\n\nclass CommandOperationV2 extends OperationBase {\n  constructor(parent, options, operationOptions) {\n    super(options);\n\n    this.ns = parent.s.namespace.withCollection('$cmd');\n    const propertyProvider = this.hasAspect(Aspect.NO_INHERIT_OPTIONS) ? undefined : parent;\n    this.readPreference = this.hasAspect(Aspect.WRITE_OPERATION)\n      ? ReadPreference.primary\n      : ReadPreference.resolve(propertyProvider, this.options);\n    this.readConcern = resolveReadConcern(propertyProvider, this.options);\n    this.writeConcern = resolveWriteConcern(propertyProvider, this.options);\n\n    if (operationOptions && typeof operationOptions.fullResponse === 'boolean') {\n      this.fullResponse = true;\n    }\n\n    // TODO: A lot of our code depends on having the read preference in the options. This should\n    //       go away, but also requires massive test rewrites.\n    this.options.readPreference = this.readPreference;\n\n    // TODO(NODE-2056): make logger another \"inheritable\" property\n    if (parent.s.logger) {\n      this.logger = parent.s.logger;\n    } else if (parent.s.db && parent.s.db.logger) {\n      this.logger = parent.s.db.logger;\n    }\n  }\n\n  executeCommand(server, cmd, callback) {\n    // TODO: consider making this a non-enumerable property\n    this.server = server;\n\n    const options = this.options;\n    const serverWireVersion = maxWireVersion(server);\n    const inTransaction = this.session && this.session.inTransaction();\n\n    if (this.readConcern && commandSupportsReadConcern(cmd) && !inTransaction) {\n      Object.assign(cmd, { readConcern: this.readConcern });\n    }\n\n    if (options.collation && serverWireVersion < SUPPORTS_WRITE_CONCERN_AND_COLLATION) {\n      callback(\n        new MongoError(\n          `Server ${server.name}, which reports wire version ${serverWireVersion}, does not support collation`\n        )\n      );\n      return;\n    }\n\n    if (serverWireVersion >= SUPPORTS_WRITE_CONCERN_AND_COLLATION) {\n      if (this.writeConcern && this.hasAspect(Aspect.WRITE_OPERATION)) {\n        Object.assign(cmd, { writeConcern: this.writeConcern });\n      }\n\n      if (options.collation && typeof options.collation === 'object') {\n        Object.assign(cmd, { collation: options.collation });\n      }\n    }\n\n    if (typeof options.maxTimeMS === 'number') {\n      cmd.maxTimeMS = options.maxTimeMS;\n    }\n\n    if (typeof options.comment === 'string') {\n      cmd.comment = options.comment;\n    }\n\n    if (this.hasAspect(Aspect.EXPLAINABLE) && this.explain) {\n      if (serverWireVersion < 6 && cmd.aggregate) {\n        // Prior to 3.6, with aggregate, verbosity is ignored, and we must pass in \"explain: true\"\n        cmd.explain = true;\n      } else {\n        cmd = decorateWithExplain(cmd, this.explain);\n      }\n    }\n\n    if (this.logger && this.logger.isDebug()) {\n      this.logger.debug(`executing command ${JSON.stringify(cmd)} against ${this.ns}`);\n    }\n\n    server.command(this.ns.toString(), cmd, this.options, (err, result) => {\n      if (err) {\n        callback(err, null);\n        return;\n      }\n\n      if (this.fullResponse) {\n        callback(null, result);\n        return;\n      }\n\n      callback(null, result.result);\n    });\n  }\n}\n\nfunction resolveWriteConcern(parent, options) {\n  return WriteConcern.fromOptions(options) || (parent && parent.writeConcern);\n}\n\nfunction resolveReadConcern(parent, options) {\n  return ReadConcern.fromOptions(options) || (parent && parent.readConcern);\n}\n\nmodule.exports = CommandOperationV2;\n"],"names":["require$$0","require$$1","require$$2","require$$3","require$$4","require$$5","WriteConcern","ReadConcern"],"mappings":"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"}