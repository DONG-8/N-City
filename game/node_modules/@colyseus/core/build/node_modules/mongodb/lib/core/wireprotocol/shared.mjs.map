{"version":3,"file":"shared.mjs","sources":["../../../../../../../../node_modules/mongodb/lib/core/wireprotocol/shared.js"],"sourcesContent":["'use strict';\n\nconst ReadPreference = require('../topologies/read_preference');\nconst MongoError = require('../error').MongoError;\nconst ServerType = require('../sdam/common').ServerType;\nconst TopologyDescription = require('../sdam/topology_description').TopologyDescription;\n\nconst MESSAGE_HEADER_SIZE = 16;\nconst COMPRESSION_DETAILS_SIZE = 9; // originalOpcode + uncompressedSize, compressorID\n\n// OPCODE Numbers\n// Defined at https://docs.mongodb.com/manual/reference/mongodb-wire-protocol/#request-opcodes\nvar opcodes = {\n  OP_REPLY: 1,\n  OP_UPDATE: 2001,\n  OP_INSERT: 2002,\n  OP_QUERY: 2004,\n  OP_GETMORE: 2005,\n  OP_DELETE: 2006,\n  OP_KILL_CURSORS: 2007,\n  OP_COMPRESSED: 2012,\n  OP_MSG: 2013\n};\n\nvar getReadPreference = function(cmd, options) {\n  // Default to command version of the readPreference\n  var readPreference = cmd.readPreference || new ReadPreference('primary');\n  // If we have an option readPreference override the command one\n  if (options.readPreference) {\n    readPreference = options.readPreference;\n  }\n\n  if (typeof readPreference === 'string') {\n    readPreference = new ReadPreference(readPreference);\n  }\n\n  if (!(readPreference instanceof ReadPreference)) {\n    throw new MongoError('read preference must be a ReadPreference instance');\n  }\n\n  return readPreference;\n};\n\n// Parses the header of a wire protocol message\nvar parseHeader = function(message) {\n  return {\n    length: message.readInt32LE(0),\n    requestId: message.readInt32LE(4),\n    responseTo: message.readInt32LE(8),\n    opCode: message.readInt32LE(12)\n  };\n};\n\nfunction applyCommonQueryOptions(queryOptions, options) {\n  Object.assign(queryOptions, {\n    raw: typeof options.raw === 'boolean' ? options.raw : false,\n    promoteLongs: typeof options.promoteLongs === 'boolean' ? options.promoteLongs : true,\n    promoteValues: typeof options.promoteValues === 'boolean' ? options.promoteValues : true,\n    promoteBuffers: typeof options.promoteBuffers === 'boolean' ? options.promoteBuffers : false,\n    monitoring: typeof options.monitoring === 'boolean' ? options.monitoring : false,\n    fullResult: typeof options.fullResult === 'boolean' ? options.fullResult : false\n  });\n\n  if (typeof options.socketTimeout === 'number') {\n    queryOptions.socketTimeout = options.socketTimeout;\n  }\n\n  if (options.session) {\n    queryOptions.session = options.session;\n  }\n\n  if (typeof options.documentsReturnedIn === 'string') {\n    queryOptions.documentsReturnedIn = options.documentsReturnedIn;\n  }\n\n  return queryOptions;\n}\n\nfunction isSharded(topologyOrServer) {\n  if (topologyOrServer.type === 'mongos') return true;\n  if (topologyOrServer.description && topologyOrServer.description.type === ServerType.Mongos) {\n    return true;\n  }\n\n  // NOTE: This is incredibly inefficient, and should be removed once command construction\n  //       happens based on `Server` not `Topology`.\n  if (topologyOrServer.description && topologyOrServer.description instanceof TopologyDescription) {\n    const servers = Array.from(topologyOrServer.description.servers.values());\n    return servers.some(server => server.type === ServerType.Mongos);\n  }\n\n  return false;\n}\n\nfunction databaseNamespace(ns) {\n  return ns.split('.')[0];\n}\nfunction collectionNamespace(ns) {\n  return ns\n    .split('.')\n    .slice(1)\n    .join('.');\n}\n\nmodule.exports = {\n  getReadPreference,\n  MESSAGE_HEADER_SIZE,\n  COMPRESSION_DETAILS_SIZE,\n  opcodes,\n  parseHeader,\n  applyCommonQueryOptions,\n  isSharded,\n  databaseNamespace,\n  collectionNamespace\n};\n"],"names":["require$$0","require$$1","require$$2","ReadPreference"],"mappings":"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"}