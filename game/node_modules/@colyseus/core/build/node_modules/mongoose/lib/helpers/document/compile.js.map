{"version":3,"file":"compile.js","sources":["../../../../../../../../node_modules/mongoose/lib/helpers/document/compile.js"],"sourcesContent":["'use strict';\n\nconst documentSchemaSymbol = require('../../helpers/symbols').documentSchemaSymbol;\nconst get = require('../../helpers/get');\nconst internalToObjectOptions = require('../../options').internalToObjectOptions;\nconst utils = require('../../utils');\n\nlet Document;\nconst getSymbol = require('../../helpers/symbols').getSymbol;\nconst scopeSymbol = require('../../helpers/symbols').scopeSymbol;\n\n/*!\n * exports\n */\n\nexports.compile = compile;\nexports.defineKey = defineKey;\n\n/*!\n * Compiles schemas.\n */\n\nfunction compile(tree, proto, prefix, options) {\n  Document = Document || require('../../document');\n  const keys = Object.keys(tree);\n  const len = keys.length;\n  let limb;\n  let key;\n\n  for (let i = 0; i < len; ++i) {\n    key = keys[i];\n    limb = tree[key];\n\n    const hasSubprops = utils.isPOJO(limb) && Object.keys(limb).length &&\n      (!limb[options.typeKey] || (options.typeKey === 'type' && limb.type.type));\n    const subprops = hasSubprops ? limb : null;\n\n    defineKey(key, subprops, proto, prefix, keys, options);\n  }\n}\n\n/*!\n * Defines the accessor named prop on the incoming prototype.\n */\n\nfunction defineKey(prop, subprops, prototype, prefix, keys, options) {\n  Document = Document || require('../../document');\n  const path = (prefix ? prefix + '.' : '') + prop;\n  prefix = prefix || '';\n\n  if (subprops) {\n    Object.defineProperty(prototype, prop, {\n      enumerable: true,\n      configurable: true,\n      get: function() {\n        const _this = this;\n        if (!this.$__.getters) {\n          this.$__.getters = {};\n        }\n\n        if (!this.$__.getters[path]) {\n          const nested = Object.create(Document.prototype, getOwnPropertyDescriptors(this));\n\n          // save scope for nested getters/setters\n          if (!prefix) {\n            nested.$__[scopeSymbol] = this;\n          }\n          nested.$__.nestedPath = path;\n\n          Object.defineProperty(nested, 'schema', {\n            enumerable: false,\n            configurable: true,\n            writable: false,\n            value: prototype.schema\n          });\n\n          Object.defineProperty(nested, '$__schema', {\n            enumerable: false,\n            configurable: true,\n            writable: false,\n            value: prototype.schema\n          });\n\n          Object.defineProperty(nested, documentSchemaSymbol, {\n            enumerable: false,\n            configurable: true,\n            writable: false,\n            value: prototype.schema\n          });\n\n          Object.defineProperty(nested, 'toObject', {\n            enumerable: false,\n            configurable: true,\n            writable: false,\n            value: function() {\n              return utils.clone(_this.get(path, null, {\n                virtuals: get(this, 'schema.options.toObject.virtuals', null)\n              }));\n            }\n          });\n\n          Object.defineProperty(nested, '$__get', {\n            enumerable: false,\n            configurable: true,\n            writable: false,\n            value: function() {\n              return _this.get(path, null, {\n                virtuals: get(this, 'schema.options.toObject.virtuals', null)\n              });\n            }\n          });\n\n          Object.defineProperty(nested, 'toJSON', {\n            enumerable: false,\n            configurable: true,\n            writable: false,\n            value: function() {\n              return _this.get(path, null, {\n                virtuals: get(_this, 'schema.options.toJSON.virtuals', null)\n              });\n            }\n          });\n\n          Object.defineProperty(nested, '$__isNested', {\n            enumerable: false,\n            configurable: true,\n            writable: false,\n            value: true\n          });\n\n          const _isEmptyOptions = Object.freeze({\n            minimize: true,\n            virtuals: false,\n            getters: false,\n            transform: false\n          });\n          Object.defineProperty(nested, '$isEmpty', {\n            enumerable: false,\n            configurable: true,\n            writable: false,\n            value: function() {\n              return Object.keys(this.get(path, null, _isEmptyOptions) || {}).length === 0;\n            }\n          });\n\n          Object.defineProperty(nested, '$__parent', {\n            enumerable: false,\n            configurable: true,\n            writable: false,\n            value: this\n          });\n\n          compile(subprops, nested, path, options);\n          this.$__.getters[path] = nested;\n        }\n\n        return this.$__.getters[path];\n      },\n      set: function(v) {\n        if (v != null && v.$__isNested) {\n          // Convert top-level to POJO, but leave subdocs hydrated so `$set`\n          // can handle them. See gh-9293.\n          v = v.$__get();\n        } else if (v instanceof Document && !v.$__isNested) {\n          v = v.toObject(internalToObjectOptions);\n        }\n        const doc = this.$__[scopeSymbol] || this;\n        doc.$set(path, v);\n      }\n    });\n  } else {\n    Object.defineProperty(prototype, prop, {\n      enumerable: true,\n      configurable: true,\n      get: function() {\n        return this[getSymbol].call(this.$__[scopeSymbol] || this, path);\n      },\n      set: function(v) {\n        this.$set.call(this.$__[scopeSymbol] || this, path, v);\n      }\n    });\n  }\n}\n\n// gets descriptors for all properties of `object`\n// makes all properties non-enumerable to match previous behavior to #2211\nfunction getOwnPropertyDescriptors(object) {\n  const result = {};\n\n  Object.getOwnPropertyNames(object).forEach(function(key) {\n    result[key] = Object.getOwnPropertyDescriptor(object, key);\n    // Assume these are schema paths, ignore them re: #5470\n    if (result[key].get) {\n      delete result[key];\n      return;\n    }\n    result[key].enumerable = [\n      'isNew',\n      '$__',\n      'errors',\n      '_doc',\n      '$locals',\n      '$op',\n      '__parentArray',\n      '__index',\n      '$isDocumentArrayElement'\n    ].indexOf(key) === -1;\n  });\n\n  return result;\n}\n"],"names":["require$$0","require$$1","require$$2"],"mappings":"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"}