{"version":3,"file":"setupTimestamps.js","sources":["../../../../../../../../node_modules/mongoose/lib/helpers/timestamps/setupTimestamps.js"],"sourcesContent":["'use strict';\n\nconst applyTimestampsToChildren = require('../update/applyTimestampsToChildren');\nconst applyTimestampsToUpdate = require('../update/applyTimestampsToUpdate');\nconst get = require('../get');\nconst handleTimestampOption = require('../schema/handleTimestampOption');\nconst symbols = require('../../schema/symbols');\n\nmodule.exports = function setupTimestamps(schema, timestamps) {\n  const childHasTimestamp = schema.childSchemas.find(withTimestamp);\n\n  function withTimestamp(s) {\n    const ts = s.schema.options.timestamps;\n    return !!ts;\n  }\n\n  if (!timestamps && !childHasTimestamp) {\n    return;\n  }\n\n  const createdAt = handleTimestampOption(timestamps, 'createdAt');\n  const updatedAt = handleTimestampOption(timestamps, 'updatedAt');\n  const currentTime = timestamps != null && timestamps.hasOwnProperty('currentTime') ?\n    timestamps.currentTime :\n    null;\n  const schemaAdditions = {};\n\n  schema.$timestamps = { createdAt: createdAt, updatedAt: updatedAt };\n\n  if (updatedAt && !schema.paths[updatedAt]) {\n    schemaAdditions[updatedAt] = Date;\n  }\n\n  if (createdAt && !schema.paths[createdAt]) {\n    schemaAdditions[createdAt] = Date;\n  }\n\n  schema.add(schemaAdditions);\n\n  schema.pre('save', function(next) {\n    const timestampOption = get(this, '$__.saveOptions.timestamps');\n    if (timestampOption === false) {\n      return next();\n    }\n\n    const skipUpdatedAt = timestampOption != null && timestampOption.updatedAt === false;\n    const skipCreatedAt = timestampOption != null && timestampOption.createdAt === false;\n\n    const defaultTimestamp = currentTime != null ?\n      currentTime() :\n      (this.ownerDocument ? this.ownerDocument() : this).constructor.base.now();\n    const auto_id = this._id && this._id.auto;\n\n    if (!skipCreatedAt && createdAt && !this.get(createdAt) && this.$__isSelected(createdAt)) {\n      this.$set(createdAt, auto_id ? this._id.getTimestamp() : defaultTimestamp);\n    }\n\n    if (!skipUpdatedAt && updatedAt && (this.isNew || this.isModified())) {\n      let ts = defaultTimestamp;\n      if (this.isNew) {\n        if (createdAt != null) {\n          ts = this.$__getValue(createdAt);\n        } else if (auto_id) {\n          ts = this._id.getTimestamp();\n        }\n      }\n      this.$set(updatedAt, ts);\n    }\n\n    next();\n  });\n\n  schema.methods.initializeTimestamps = function() {\n    const ts = currentTime != null ?\n      currentTime() :\n      this.constructor.base.now();\n    if (createdAt && !this.get(createdAt)) {\n      this.$set(createdAt, ts);\n    }\n    if (updatedAt && !this.get(updatedAt)) {\n      this.$set(updatedAt, ts);\n    }\n    return this;\n  };\n\n  _setTimestampsOnUpdate[symbols.builtInMiddleware] = true;\n\n  const opts = { query: true, model: false };\n  schema.pre('findOneAndReplace', opts, _setTimestampsOnUpdate);\n  schema.pre('findOneAndUpdate', opts, _setTimestampsOnUpdate);\n  schema.pre('replaceOne', opts, _setTimestampsOnUpdate);\n  schema.pre('update', opts, _setTimestampsOnUpdate);\n  schema.pre('updateOne', opts, _setTimestampsOnUpdate);\n  schema.pre('updateMany', opts, _setTimestampsOnUpdate);\n\n  function _setTimestampsOnUpdate(next) {\n    const now = currentTime != null ?\n      currentTime() :\n      this.model.base.now();\n\n    // Replacing with null update should still trigger timestamps\n    if (this.op === 'findOneAndReplace' && this.getUpdate() == null) {\n      this.setUpdate({});\n    }\n\n    applyTimestampsToUpdate(now, createdAt, updatedAt, this.getUpdate(),\n      this.options, this.schema);\n    applyTimestampsToChildren(now, this.getUpdate(), this.model.schema);\n    next();\n  }\n};"],"names":["symbols"],"mappings":"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"}