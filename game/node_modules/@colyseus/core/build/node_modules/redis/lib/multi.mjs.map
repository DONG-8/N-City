{"version":3,"file":"multi.mjs","sources":["../../../../../../node_modules/redis/lib/multi.js"],"sourcesContent":["'use strict';\n\nvar Queue = require('double-ended-queue');\nvar utils = require('./utils');\nvar Command = require('./command');\n\nfunction Multi (client, args) {\n    this._client = client;\n    this.queue = new Queue();\n    var command, tmp_args;\n    if (args) { // Either undefined or an array. Fail hard if it's not an array\n        for (var i = 0; i < args.length; i++) {\n            command = args[i][0];\n            tmp_args = args[i].slice(1);\n            if (Array.isArray(command)) {\n                this[command[0]].apply(this, command.slice(1).concat(tmp_args));\n            } else {\n                this[command].apply(this, tmp_args);\n            }\n        }\n    }\n}\n\nfunction pipeline_transaction_command (self, command_obj, index) {\n    // Queueing is done first, then the commands are executed\n    var tmp = command_obj.callback;\n    command_obj.callback = function (err, reply) {\n        // Ignore the multi command. This is applied by node_redis and the user does not benefit by it\n        if (err && index !== -1) {\n            if (tmp) {\n                tmp(err);\n            }\n            err.position = index;\n            self.errors.push(err);\n        }\n        // Keep track of who wants buffer responses:\n        // By the time the callback is called the command_obj got the buffer_args attribute attached\n        self.wants_buffers[index] = command_obj.buffer_args;\n        command_obj.callback = tmp;\n    };\n    self._client.internal_send_command(command_obj);\n}\n\nMulti.prototype.exec_atomic = Multi.prototype.EXEC_ATOMIC = Multi.prototype.execAtomic = function exec_atomic (callback) {\n    if (this.queue.length < 2) {\n        return this.exec_batch(callback);\n    }\n    return this.exec(callback);\n};\n\nfunction multi_callback (self, err, replies) {\n    var i = 0, command_obj;\n\n    if (err) {\n        err.errors = self.errors;\n        if (self.callback) {\n            self.callback(err);\n            // Exclude connection errors so that those errors won't be emitted twice\n        } else if (err.code !== 'CONNECTION_BROKEN') {\n            self._client.emit('error', err);\n        }\n        return;\n    }\n\n    if (replies) {\n        while (command_obj = self.queue.shift()) {\n            if (replies[i] instanceof Error) {\n                var match = replies[i].message.match(utils.err_code);\n                // LUA script could return user errors that don't behave like all other errors!\n                if (match) {\n                    replies[i].code = match[1];\n                }\n                replies[i].command = command_obj.command.toUpperCase();\n                if (typeof command_obj.callback === 'function') {\n                    command_obj.callback(replies[i]);\n                }\n            } else {\n                // If we asked for strings, even in detect_buffers mode, then return strings:\n                replies[i] = self._client.handle_reply(replies[i], command_obj.command, self.wants_buffers[i]);\n                if (typeof command_obj.callback === 'function') {\n                    command_obj.callback(null, replies[i]);\n                }\n            }\n            i++;\n        }\n    }\n\n    if (self.callback) {\n        self.callback(null, replies);\n    }\n}\n\nMulti.prototype.exec_transaction = function exec_transaction (callback) {\n    if (this.monitoring || this._client.monitoring) {\n        var err = new RangeError(\n            'Using transaction with a client that is in monitor mode does not work due to faulty return values of Redis.'\n        );\n        err.command = 'EXEC';\n        err.code = 'EXECABORT';\n        return utils.reply_in_order(this._client, callback, err);\n    }\n    var self = this;\n    var len = self.queue.length;\n    self.errors = [];\n    self.callback = callback;\n    self._client.cork();\n    self.wants_buffers = new Array(len);\n    pipeline_transaction_command(self, new Command('multi', []), -1);\n    // Drain queue, callback will catch 'QUEUED' or error\n    for (var index = 0; index < len; index++) {\n        // The commands may not be shifted off, since they are needed in the result handler\n        pipeline_transaction_command(self, self.queue.get(index), index);\n    }\n\n    self._client.internal_send_command(new Command('exec', [], function (err, replies) {\n        multi_callback(self, err, replies);\n    }));\n    self._client.uncork();\n    return !self._client.should_buffer;\n};\n\nfunction batch_callback (self, cb, i) {\n    return function batch_callback (err, res) {\n        if (err) {\n            self.results[i] = err;\n            // Add the position to the error\n            self.results[i].position = i;\n        } else {\n            self.results[i] = res;\n        }\n        cb(err, res);\n    };\n}\n\nMulti.prototype.exec = Multi.prototype.EXEC = Multi.prototype.exec_batch = function exec_batch (callback) {\n    var self = this;\n    var len = self.queue.length;\n    var index = 0;\n    var command_obj;\n    if (len === 0) {\n        utils.reply_in_order(self._client, callback, null, []);\n        return !self._client.should_buffer;\n    }\n    self._client.cork();\n    if (!callback) {\n        while (command_obj = self.queue.shift()) {\n            self._client.internal_send_command(command_obj);\n        }\n        self._client.uncork();\n        return !self._client.should_buffer;\n    }\n    var callback_without_own_cb = function (err, res) {\n        if (err) {\n            self.results.push(err);\n            // Add the position to the error\n            var i = self.results.length - 1;\n            self.results[i].position = i;\n        } else {\n            self.results.push(res);\n        }\n        // Do not emit an error here. Otherwise each error would result in one emit.\n        // The errors will be returned in the result anyway\n    };\n    var last_callback = function (cb) {\n        return function (err, res) {\n            cb(err, res);\n            callback(null, self.results);\n        };\n    };\n    self.results = [];\n    while (command_obj = self.queue.shift()) {\n        if (typeof command_obj.callback === 'function') {\n            command_obj.callback = batch_callback(self, command_obj.callback, index);\n        } else {\n            command_obj.callback = callback_without_own_cb;\n        }\n        if (typeof callback === 'function' && index === len - 1) {\n            command_obj.callback = last_callback(command_obj.callback);\n        }\n        this._client.internal_send_command(command_obj);\n        index++;\n    }\n    self._client.uncork();\n    return !self._client.should_buffer;\n};\n\nmodule.exports = Multi;\n"],"names":["Queue","Command"],"mappings":"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"}