{"version":3,"file":"Utils.mjs","sources":["../../../../src/Utils.ts"],"sourcesContent":["import nanoid from 'nanoid';\n\nimport { debugAndPrintError } from './Debug';\nimport { EventEmitter } from \"events\";\nimport { ServerOpts, Socket } from \"net\";\n\n// remote room call timeouts\nexport const REMOTE_ROOM_SHORT_TIMEOUT = Number(process.env.COLYSEUS_PRESENCE_SHORT_TIMEOUT || 2000);\n\nexport function generateId(length: number = 9) {\n  return nanoid(length);\n}\n\n//\n// nodemon sends SIGUSR2 before reloading\n// (https://github.com/remy/nodemon#controlling-shutdown-of-your-script)\n//\nconst signals: NodeJS.Signals[] = ['SIGINT', 'SIGTERM', 'SIGUSR2'];\n\nexport function registerGracefulShutdown(callback: (err?: Error) => void) {\n  /**\n   * Gracefully shutdown on uncaught errors\n   */\n  process.on('uncaughtException', (err) => {\n    debugAndPrintError(err);\n    callback(err);\n  });\n\n  signals.forEach((signal) =>\n    process.once(signal, () => callback()));\n}\n\nexport function retry<T = any>(\n  cb: Function,\n  maxRetries: number = 3,\n  errorWhiteList: any[] = [],\n  retries: number = 0,\n) {\n  return new Promise<T>((resolve, reject) => {\n    cb()\n      .then(resolve)\n      .catch((e) => {\n        if (\n          errorWhiteList.indexOf(e.constructor) !== -1 &&\n          retries++ < maxRetries\n        ) {\n          setTimeout(() => {\n            retry<T>(cb, maxRetries, errorWhiteList, retries).\n              then(resolve).\n              catch((e2) => reject(e2));\n          }, Math.floor(Math.random() * Math.pow(2, retries) * 400));\n\n        } else {\n          reject(e);\n        }\n      });\n  });\n}\n\nexport function spliceOne(arr: any[], index: number): boolean {\n  // manually splice availableRooms array\n  // http://jsperf.com/manual-splice\n  if (index === -1 || index >= arr.length) {\n    return false;\n  }\n\n  const len = arr.length - 1;\n  for (let i = index; i < len; i++) {\n    arr[i] = arr[i + 1];\n  }\n\n  arr.length = len;\n  return true;\n}\n\nexport class Deferred<T= any> {\n  public promise: Promise<T>;\n\n  public resolve: Function;\n  public reject: Function;\n\n  constructor() {\n    this.promise = new Promise<T>((resolve, reject) => {\n      this.resolve = resolve;\n      this.reject = reject;\n    });\n  }\n\n  public then(func: (value: T) => any) {\n    return this.promise.then.apply(this.promise, arguments);\n  }\n\n  public catch(func: (value: any) => any) {\n    return this.promise.catch(func);\n  }\n\n}\n\nexport function merge(a: any, ...objs: any[]): any {\n  for (let i = 0, len = objs.length; i < len; i++) {\n    const b = objs[i];\n    for (const key in b) {\n      if (b.hasOwnProperty(key)) {\n        a[key] = b[key];\n      }\n    }\n  }\n  return a;\n}\n\nexport interface HashedArray<T> {\n  [key: string]: T;\n}\n\nexport class HybridArray<T> {\n  public uniqueProperty: string;\n  public hashedArray: HashedArray<T>;\n  public array: T[];\n\n  constructor(uniquePropertyName: string, elements?: T[]) {\n    this.uniqueProperty = uniquePropertyName;\n    this.hashedArray = {};\n    this.array = [];\n    if (elements) {\n      this.array = this.array.concat(elements);\n      for (const element of elements) {\n        this.hashedArray[element[this.uniqueProperty]] = element;\n      }\n    }\n  }\n\n  public get length(): number {\n    return this.array.length;\n  }\n\n  public add(element: T) {\n    if (!this.hashedArray[element[this.uniqueProperty]]) {\n      this.array.push(element);\n      this.hashedArray[element[this.uniqueProperty]] = element;\n    } else {\n      console.error(`Element already exists for ${this.uniqueProperty}: '${element[this.uniqueProperty]}'.`);\n    }\n  }\n\n  public at(index: number) {\n    if (index >= this.array.length) {\n      this.indexError(index);\n    } else {\n      return this.array[index];\n    }\n  }\n\n  public concat(elements: T[]) {\n    if(elements) {\n      for(const element of elements) {\n        this.hashedArray[element[this.uniqueProperty]] = element;\n      }\n      this.array.concat(elements);\n    }\n  }\n\n  public forEach(fn) {\n    for (let element of this.array) {\n      fn(element);\n    }\n  }\n\n  public get(key: string): T {\n    return this.hashedArray[key];\n  }\n\n  public includes(element: T) {\n    return this.hashedArray[element[this.uniqueProperty]] !== undefined;\n  }\n\n  public indexOf(element: T): number {\n    return this.array.indexOf(element);\n  }\n\n  public map(callback) {\n    const result = [];\n    for (let index = 0; index < this.array.length; index++) {\n      result.push(callback(this.array[index], index, this.array));\n    }\n    return result;\n  }\n\n  public deleteAt(index: number) {\n    if (index >= this.array.length) {\n      this.indexError(index);\n      return undefined;\n    } else {\n      const removable = this.spliceOne(index);\n      delete this.hashedArray[removable[this.uniqueProperty]];\n      return removable;\n    }\n  }\n\n  public deleteByKey(key: string): T {\n    if (!this.hashedArray[key]) {\n      this.invalidKeyError(key);\n      return undefined;\n    } else {\n      const removable = this.spliceOne(this.indexOf(this.hashedArray[key]));\n      delete this.hashedArray[key];\n      return removable;\n    }\n  }\n\n  public delete(obj: T): T {\n    if (this.hashedArray[obj[this.uniqueProperty]]) {\n      return this.deleteByKey(obj[this.uniqueProperty]);\n    } else if (this.indexOf(obj) != -1) {\n      return this.deleteAt(this.indexOf(obj));\n    } else {\n      console.error(\"Invalid object has been provided!\");\n      return undefined;\n    }\n  }\n\n  private indexError(index) {\n    console.error(`Index out of range, index: ${index}`);\n  }\n\n  private invalidKeyError(key) {\n    console.error(`No such element for property '${this.uniqueProperty}': '${key}'.`)\n  }\n\n  private spliceOne(index: number): T {\n    // manually splice availableRooms array\n    // http://jsperf.com/manual-splice\n    if (index === -1 || index >= this.array.length) {\n      this.indexError(index);\n      return undefined;\n    }\n    const removable = this.array[index];\n    const len = this.array.length - 1;\n    for (let i = index; i < len; i++) {\n      this.array[i] = this.array[i + 1];\n    }\n    this.array.length = len;\n    return removable;\n  }\n}\n\nexport declare interface DummyServer {\n  constructor(options?: ServerOpts, connectionListener?: (socket: Socket) => void);\n\n  listen(port?: number, hostname?: string, backlog?: number, listeningListener?: () => void): this;\n  close(callback?: (err?: Error) => void): this;\n}\n\nexport class DummyServer extends EventEmitter {}\n"],"names":[],"mappings":"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"}