{"version":3,"file":"Server.mjs","sources":["../../../../src/Server.ts"],"sourcesContent":["import http, { IncomingMessage, ServerResponse } from 'http';\n\nimport { debugAndPrintError, debugMatchMaking } from './Debug';\nimport { RegisteredHandler } from './matchmaker/RegisteredHandler';\nimport { Presence } from './presence/Presence';\n\nimport * as matchMaker from './MatchMaker';\nimport * as matchMakerController from './matchmaker/controller';\n\nimport { Room } from './Room';\nimport { Type } from './types';\nimport { registerGracefulShutdown } from './Utils';\n\nimport {generateId} from '.';\nimport { registerNode, unregisterNode } from './discovery';\n\nimport { LocalPresence } from './presence/LocalPresence';\nimport { LocalDriver } from './matchmaker/driver';\n\nimport { Transport } from './Transport';\nimport { logger, setLogger } from './Logger';\n\n// IServerOptions &\nexport type ServerOptions = {\n  publicAddress?: string,\n\n  presence?: Presence,\n  driver?: matchMaker.MatchMakerDriver,\n  transport?: Transport,\n  gracefullyShutdown?: boolean,\n  logger?: any;\n\n  /**\n   * Options below are now part of WebSocketTransport (@colyseus/ws-transport)\n   * TODO: remove me on 0.15.0\n   */\n  /** @deprecated */\n  pingInterval?: number,\n\n  /** @deprecated */\n  pingMaxRetries?: number,\n\n  /** @deprecated */\n  verifyClient?: any,\n\n  /** @deprecated */\n  server?: http.Server,\n};\n\nexport class Server {\n  public transport: Transport;\n\n  protected presence: Presence;\n  protected driver: matchMaker.MatchMakerDriver;\n  protected processId: string = generateId();\n\n  protected port: number;\n\n  constructor(options: ServerOptions = {}) {\n    const { gracefullyShutdown = true } = options;\n\n    this.presence = options.presence || new LocalPresence();\n    this.driver = options.driver || new LocalDriver();\n\n    // \"presence\" option is not used from now on\n    delete options.presence;\n    this.attach(options);\n\n    // setup matchmaker\n    matchMaker.setup(\n      this.presence,\n      this.driver,\n      this.processId,\n      options.publicAddress,\n    );\n\n    if (gracefullyShutdown) {\n      registerGracefulShutdown((err) => this.gracefullyShutdown(true, err));\n    }\n\n    if(options.logger) {\n      setLogger(options.logger);\n    }\n  }\n\n  public attach(options: ServerOptions) {\n    /**\n     * Display deprecation warnings for moved Transport options.\n     * TODO: Remove me on 0.15\n     */\n    if (\n      options.pingInterval !== undefined ||\n      options.pingMaxRetries !== undefined ||\n      options.server !== undefined ||\n      options.verifyClient !== undefined\n    ) {\n      logger.warn(\"DEPRECATION WARNING: 'pingInterval', 'pingMaxRetries', 'server', and 'verifyClient' Server options will be permanently moved to WebSocketTransport on v0.15\");\n      logger.warn(`new Server({\n  transport: new WebSocketTransport({\n    pingInterval: ...,\n    pingMaxRetries: ...,\n    server: ...,\n    verifyClient: ...\n  })\n})`);\n      logger.warn(\"ðŸ‘‰ Documentation: https://docs.colyseus.io/server/transport/\")\n    }\n\n    const transport = options.transport || this.getDefaultTransport(options);\n    delete options.transport;\n\n    this.transport = transport;\n\n    if (this.transport.server) {\n      this.transport.server.once('listening', () => this.registerProcessForDiscovery());\n      this.attachMatchMakingRoutes(this.transport.server as http.Server);\n    }\n  }\n\n  /**\n   * Bind the server into the port specified.\n   *\n   * @param port\n   * @param hostname\n   * @param backlog\n   * @param listeningListener\n   */\n  public async listen(port: number, hostname?: string, backlog?: number, listeningListener?: Function) {\n    this.port = port;\n\n    return new Promise<void>((resolve, reject) => {\n      this.transport.server?.on('error', (err) => reject(err));\n      this.transport.listen(port, hostname, backlog, (err) => {\n        if (listeningListener) {\n          listeningListener(err);\n        }\n\n        if (err) {\n          reject(err);\n\n        } else {\n          resolve();\n        }\n      });\n    });\n  }\n\n  public async registerProcessForDiscovery() {\n    // register node for proxy/service discovery\n    registerNode(this.presence, {\n      port: this.port,\n      processId: this.processId,\n    });\n  }\n\n  /**\n   * Define a new type of room for matchmaking.\n   *\n   * @param name public room identifier for match-making.\n   * @param handler Room class definition\n   * @param defaultOptions default options for `onCreate`\n   */\n  public define<T extends Type<Room>>(\n    name: string,\n    handler: T,\n    defaultOptions?: Parameters<NonNullable<InstanceType<T>['onCreate']>>[0],\n  ): RegisteredHandler {\n    return matchMaker.defineRoomType(name, handler, defaultOptions);\n  }\n\n  public async gracefullyShutdown(exit: boolean = true, err?: Error) {\n    await unregisterNode(this.presence, {\n      port: this.port,\n      processId: this.processId,\n    });\n\n    try {\n      await matchMaker.gracefullyShutdown();\n\n      this.transport.shutdown();\n      this.presence.shutdown();\n      this.driver.shutdown();\n\n      await this.onShutdownCallback();\n\n    } catch (e) {\n      debugAndPrintError(`error during shutdown: ${e}`);\n\n    } finally {\n      if (exit) {\n        process.exit(err ? 1 : 0);\n      }\n    }\n  }\n\n  /**\n   * Add simulated latency between client and server.\n   * @param milliseconds round trip latency in milliseconds.\n   */\n  public simulateLatency(milliseconds: number) {\n    logger.warn(`ðŸ“¶ï¸â— Colyseus latency simulation enabled â†’ ${milliseconds}ms latency for round trip.`);\n\n    const halfwayMS = (milliseconds / 2);\n    this.transport.simulateLatency(halfwayMS);\n\n    /* tslint:disable:no-string-literal */\n    const _onMessage = Room.prototype['_onMessage'];\n    /* tslint:disable:no-string-literal */\n    Room.prototype['_onMessage'] = function (client, buffer) {\n      // uWebSockets.js: duplicate buffer because it is cleared at native layer before the timeout.\n      const cachedBuffer = Buffer.from(buffer);\n      setTimeout(() => _onMessage.call(this, client, cachedBuffer), halfwayMS);\n    };\n  }\n\n  /**\n   * Register a callback that is going to be executed before the server shuts down.\n   * @param callback\n   */\n  public onShutdown(callback: () => void | Promise<any>) {\n    this.onShutdownCallback = callback;\n  }\n\n  protected getDefaultTransport(_: any): Transport {\n    throw new Error(\"Please provide a 'transport' layer. Default transport not set.\");\n  }\n\n  protected onShutdownCallback: () => void | Promise<any> =\n    () => Promise.resolve()\n\n  protected attachMatchMakingRoutes(server: http.Server) {\n    const listeners = server.listeners('request').slice(0);\n    server.removeAllListeners('request');\n\n    server.on('request', (req, res) => {\n      if (req.url.indexOf(`/${matchMakerController.matchmakeRoute}`) !== -1) {\n        debugMatchMaking('received matchmake request: %s', req.url);\n        this.handleMatchMakeRequest(req, res);\n\n      } else {\n        for (let i = 0, l = listeners.length; i < l; i++) {\n          listeners[i].call(server, req, res);\n        }\n      }\n    });\n  }\n\n  protected async handleMatchMakeRequest(req: IncomingMessage, res: ServerResponse) {\n    const headers = {\n      'Access-Control-Allow-Headers': 'Origin, X-Requested-With, Content-Type, Accept',\n      'Access-Control-Allow-Methods': 'OPTIONS, POST, GET',\n      'Access-Control-Allow-Origin': '*',\n      'Access-Control-Max-Age': 2592000,\n      // ...\n    };\n\n    if (req.method === 'OPTIONS') {\n      res.writeHead(204, headers);\n      res.end();\n\n    } else if (req.method === 'POST') {\n      const matchedParams = req.url.match(matchMakerController.allowedRoomNameChars);\n      const matchmakeIndex = matchedParams.indexOf(matchMakerController.matchmakeRoute);\n      const method = matchedParams[matchmakeIndex + 1];\n      const name = matchedParams[matchmakeIndex + 2] || '';\n\n      const data = [];\n      req.on('data', (chunk) => data.push(chunk));\n      req.on('end', async () => {\n        headers['Content-Type'] = 'application/json';\n        res.writeHead(200, headers);\n\n        const clientOptions = JSON.parse(Buffer.concat(data).toString());\n        try {\n          const response = await matchMakerController.invokeMethod(method, name, clientOptions);\n          res.write(JSON.stringify(response));\n\n        } catch (e) {\n          res.write(JSON.stringify({ code: e.code, error: e.message, }));\n        }\n\n        res.end();\n      });\n\n    } else if (req.method === 'GET') {\n      const matchedParams = req.url.match(matchMakerController.allowedRoomNameChars);\n      const roomName = matchedParams.length > 1 ? matchedParams[matchedParams.length - 1] : \"\";\n\n      headers['Content-Type'] = 'application/json';\n      res.writeHead(200, headers);\n      res.write(JSON.stringify(await matchMakerController.getAvailableRooms(roomName)));\n      res.end();\n    }\n\n  }\n\n}\n"],"names":["matchMaker.setup","matchMaker.defineRoomType","matchMaker.gracefullyShutdown","matchMakerController.matchmakeRoute","matchMakerController.allowedRoomNameChars","matchMakerController.invokeMethod","matchMakerController.getAvailableRooms"],"mappings":"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"}